<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>项目篇 | 宇汐的时光录</title><meta name="author" content="宇汐"><meta name="copyright" content="宇汐"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1.仿B站视频项目2.仿牛客论坛项目1.首页帖子分页展示1.首先定义与帖子和分页相关的实体类  主要有当前页码current,每页显示的个数limit,帖子的总数rows,查询的路径path(也就是复用分页的连接),还需要做一下简单的判读,比如说页码数必须大于0,限制一下每页的条数 同时还需要声明一些其他的get方法,比如说获取当前页的起始行offset(为了写SQL语句时方便),以及获取总的页数">
<meta property="og:type" content="article">
<meta property="og:title" content="项目篇">
<meta property="og:url" content="http://example.com/2022/05/17/%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/%E9%A1%B9%E7%9B%AE/index.html">
<meta property="og:site_name" content="宇汐的时光录">
<meta property="og:description" content="1.仿B站视频项目2.仿牛客论坛项目1.首页帖子分页展示1.首先定义与帖子和分页相关的实体类  主要有当前页码current,每页显示的个数limit,帖子的总数rows,查询的路径path(也就是复用分页的连接),还需要做一下简单的判读,比如说页码数必须大于0,限制一下每页的条数 同时还需要声明一些其他的get方法,比如说获取当前页的起始行offset(为了写SQL语句时方便),以及获取总的页数">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://siyu-1314.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2/background1.jpg">
<meta property="article:published_time" content="2022-05-17T01:48:37.731Z">
<meta property="article:modified_time" content="2022-05-22T14:10:47.005Z">
<meta property="article:author" content="宇汐">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://siyu-1314.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2/background1.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2022/05/17/%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/%E9%A1%B9%E7%9B%AE/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":800},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: 宇汐","link":"链接: ","source":"来源: 宇汐的时光录","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '项目篇',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-05-22 22:10:47'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://siyu-1314.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2/header.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 联系我</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://siyu-1314.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2/background1.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">宇汐的时光录</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 联系我</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">项目篇</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-05-17T01:48:37.731Z" title="发表于 2022-05-17 09:48:37">2022-05-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-05-22T14:10:47.005Z" title="更新于 2022-05-22 22:10:47">2022-05-22</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">15.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>59分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="项目篇"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="1-仿B站视频项目"><a href="#1-仿B站视频项目" class="headerlink" title="1.仿B站视频项目"></a>1.仿B站视频项目</h2><h2 id="2-仿牛客论坛项目"><a href="#2-仿牛客论坛项目" class="headerlink" title="2.仿牛客论坛项目"></a>2.仿牛客论坛项目</h2><h3 id="1-首页帖子分页展示"><a href="#1-首页帖子分页展示" class="headerlink" title="1.首页帖子分页展示"></a>1.首页帖子分页展示</h3><p>1.首先定义与帖子和分页相关的<strong>实体类</strong></p>
<ul>
<li>主要有当前页码<code>current</code>,每页显示的个数<code>limit</code>,帖子的总数<code>rows</code>,查询的路径<code>path</code>(也就是复用分页的连接),还需要做一下简单的判读,比如说页码数必须大于0,限制一下每页的条数</li>
<li>同时还需要声明一些其他的get方法,比如说获取当前页的起始行<code>offset</code>(为了写SQL语句时方便),以及获取总的页数<code>total=rows/limit</code>,获取显示的起始页码<code>from=curret-2</code>以及终止页码<code>to=current+2</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//帖子相关的属性</span></span><br><span class="line"><span class="keyword">private</span> Integer id;      <span class="comment">//帖子id</span></span><br><span class="line">   <span class="keyword">private</span> Integer userId;  <span class="comment">//用户id</span></span><br><span class="line">   <span class="keyword">private</span> String title;    <span class="comment">//帖子title</span></span><br><span class="line">   <span class="keyword">private</span> String content;  <span class="comment">//帖子内容</span></span><br><span class="line">   <span class="keyword">private</span> Integer type;    <span class="comment">//帖子类型 0-普通; 1-置顶;</span></span><br><span class="line">   <span class="keyword">private</span> Integer status;  <span class="comment">//帖子状态 0-正常; 1-精华; 2-拉黑;</span></span><br><span class="line">   <span class="keyword">private</span> Date createTime; <span class="comment">//创建时间</span></span><br><span class="line">   <span class="keyword">private</span> Double score;</span><br><span class="line"><span class="comment">//分页相关的属性</span></span><br><span class="line"><span class="keyword">private</span> Integer current=<span class="number">1</span>;     <span class="comment">//当前页码,1为默认值</span></span><br><span class="line">   <span class="keyword">private</span> Integer limit=<span class="number">10</span>;      <span class="comment">//每页的条数,10为默认值</span></span><br><span class="line">   <span class="keyword">private</span> Integer rows;          <span class="comment">//数据的总数(计算总页数)</span></span><br><span class="line">   <span class="keyword">private</span> String path;           <span class="comment">//查询路径(用于复用分页的链接)</span></span><br></pre></td></tr></table></figure>

<p>2.接着是定义<strong>持久层</strong>,声明了两个接口,并通过mybatis编写sql语句实现</p>
<p>一个是<strong>显示帖子详情</strong>的接口,根据用户id<code>userId</code>,分页查询的起始行<code>offset</code>,每页的条数<code>limit</code>去获取帖子的详情,当用户id为0时,默认查询所有的帖子,当为指定的用户id,查询该用户的帖子进行分页显示</p>
<p>另一个<strong>获取帖子的总数</strong>的接口,规定当用户id为0时,查询所有的帖子,用户id为指定的用户id,查询该用户帖子的总数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;DiscussPost&gt; <span class="title function_">selectDiscussPosts</span><span class="params">(Integer userId, <span class="type">int</span> offset, <span class="type">int</span> limit)</span>;</span><br><span class="line">Integer <span class="title function_">selectDiscussPostRows</span><span class="params">(Integer userId)</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--查询讨论帖子分页的信息--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectDiscussPosts&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.zz.community.entity.DiscussPost&quot;</span>&gt;</span></span><br><span class="line">      select <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;selectFields&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">      from discuss_post</span><br><span class="line">      where status!=2</span><br><span class="line">      <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userId!=0&quot;</span>&gt;</span></span><br><span class="line">          and user_id=#&#123;userId&#125;	/*用户id为0,显示所有帖子详情*/</span><br><span class="line">      <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">      order by type desc,create_time desc</span><br><span class="line">      limit #&#123;offset&#125;,#&#123;limit&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--查询用户讨论帖子的总数--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectDiscussPostRows&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span></span><br><span class="line">      select count(id)</span><br><span class="line">      from discuss_post</span><br><span class="line">      where status!=2</span><br><span class="line">      <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userId!=0&quot;</span>&gt;</span>	/*用户id为0的话,默认显示所有帖子数量*/</span><br><span class="line">          and user_id=#&#123;userId&#125;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3.<strong>service层</strong>中的方法其实和mapper层的两个方法差不多,通过调用mapper层中的两个方法,在service层中也实现查询帖子详情,帖子数量的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> DiscussPostMapper discussPostMapper;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> List&lt;DiscussPost&gt; <span class="title function_">findDiscussPost</span><span class="params">(Integer userId, <span class="type">int</span> offset, <span class="type">int</span> limit)</span> &#123;</span><br><span class="line">  List&lt;DiscussPost&gt; list = discussPostMapper.selectDiscussPosts(userId, offset,limit);</span><br><span class="line">      <span class="keyword">return</span> list;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">findDiscussPostRows</span><span class="params">(Integer userId)</span> &#123;</span><br><span class="line">      <span class="type">Integer</span> <span class="variable">sum</span> <span class="operator">=</span> discussPostMapper.selectDiscussPostRows(userId);</span><br><span class="line">      <span class="keyword">return</span> sum;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>4.<strong>controller</strong>层中通过是一个返回首页的方法,将page数据传入到方法中,在前端引擎可以直接访问</p>
<p>在这个方法中通过调用service层中的方法获取帖子的数量以及用户的信息封装到一个新的集合中,然后通过model.addAttribute方法将数据传递给前端页面,在前端页面可以调用通过el表达式 ${}可以获取到</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/index&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getIndexPage</span><span class="params">(Model model, Page page)</span>&#123;</span><br><span class="line">        <span class="comment">//springMVC会将参数model,page自动实例化,注入Model,在thymeleaf可直接访问里面的数据</span></span><br><span class="line">        page.setRows(discussPostService.findDiscussPostRows(<span class="number">0</span>));</span><br><span class="line">        page.setPath(<span class="string">&quot;/index&quot;</span>);</span><br><span class="line">        <span class="comment">//查询十条数据</span></span><br><span class="line">        List&lt;DiscussPost&gt; list = discussPostService.findDiscussPost(<span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">        <span class="comment">//声明一个map类型的集合,保存帖子内容和用户信息</span></span><br><span class="line">        ArrayList&lt;Map&lt;String, Object&gt;&gt; discussPosts = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (list!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//遍历得到的帖子</span></span><br><span class="line">            <span class="keyword">for</span> (DiscussPost post:list)&#123;</span><br><span class="line">                HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                map.put(<span class="string">&quot;post&quot;</span>, post);  <span class="comment">//将帖子放入map</span></span><br><span class="line">                <span class="comment">//根据帖子中的userId查询用户的信息</span></span><br><span class="line">                <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(post.getUserId());</span><br><span class="line">                map.put(<span class="string">&quot;user&quot;</span>,user);   <span class="comment">//将用户信息放入map中</span></span><br><span class="line">                discussPosts.add(map);  <span class="comment">//将帖子和用户信息保存到最终的集合中</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;discussPosts&quot;</span>,discussPosts);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/index&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-登录注册功能"><a href="#2-登录注册功能" class="headerlink" title="2.登录注册功能"></a>2.登录注册功能</h3><h4 id="发送邮件"><a href="#发送邮件" class="headerlink" title="发送邮件"></a>发送邮件</h4><ol>
<li>将发送邮件的功能封装为了一个工具类,并交给spring管理,在使用的时候直接调用即可</li>
<li>项目中引入了springboot整合发送邮件的依赖<code>spring-boot-starter-mail</code>,可以快速简单地开发出发送邮件的功能</li>
<li>同时在配置文件中还需要声明一些邮箱的基本配置,比如说邮箱的服务地址,用户名密码等,最后在方法中调用api相关的方法即可</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">final</span> JavaMailSender mailSender;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> to 收件人</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subject   邮件主题</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content   邮件内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMail</span><span class="params">(String to,String subject,String content)</span>&#123;</span><br><span class="line">        <span class="type">MimeMessage</span> <span class="variable">message</span> <span class="operator">=</span> mailSender.createMimeMessage();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">MimeMessageHelper</span> <span class="variable">helper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeMessageHelper</span>(message);</span><br><span class="line">            helper.setFrom(from);</span><br><span class="line">            helper.setTo(to);</span><br><span class="line">            helper.setSubject(subject);</span><br><span class="line">            helper.setText(content,<span class="literal">true</span>);</span><br><span class="line">            mailSender.send(helper.getMimeMessage());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MessagingException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;发送邮件失败&quot;</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="注册功能"><a href="#注册功能" class="headerlink" title="注册功能"></a>注册功能</h4><ol>
<li><p>注册页面主要是让用户输入账号,输入密码并二次确认密码,输入注册时所需的邮箱,具体开发流程如下</p>
</li>
<li><p>在业务层主要有两个方法,一个返回值为Map类型的注册方法,参数是用户的实体,一个返回值为int的激活账户的方法,参数是用户id,以及激活码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String,Object&gt; <span class="title function_">register</span><span class="params">(User user)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">activation</span><span class="params">(<span class="type">int</span> userId,String code)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>注册方法</strong>中,首先根据传入的对象做一些简单的判断,比如说用户名,密码,邮箱都不能为空,如果为空的话,将提示信息放入map集合中</li>
<li>然后去数据库判断输入的用户名和邮箱在数据库中是否已经存在,如果存在的话,将相应的提示信息存入到map集合中</li>
<li>如果以上判断都通过的话,那么就可以进行注册<ul>
<li>首先将用户的密码进行加密处理,这里使用md5进行加密,将密码后拼接五个随机的字符,然后再进行加密,进一步保证了密码的安全性</li>
<li>同时对用户设置一些默认的属性,比如说用户的头像,注册时间,用户的类型(默认为普通用户),用户的随机激活码,以及用户的激活状态,激活状态默认为未激活,需要通过邮箱进行激活</li>
<li>最后将这些用户的信息保存到数据库中</li>
</ul>
</li>
<li>之后要去发送邮件,根据用户的邮箱去发送邮件,邮件的内容为一个链接,链接的内容拼接的有用户名以及用户的验证码</li>
</ul>
</li>
<li><p><strong>激活账户</strong>的方法中,首先根据用户id查出这个用户,然后找出用户的激活状态,然后进行判断,如果用户状态为1,那么已经激活了,不需要重复进行激活了,如果验证码与数据库中的验证码一直且用户状态为0,那么对其更新为1,其他状态那么就返回激活失败的情况.</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">register</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (user==<span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;参数不能为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//账号不能为空</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(user.getUsername()))&#123;</span><br><span class="line">            map.put(<span class="string">&quot;usernameMsg&quot;</span>, <span class="string">&quot;账号不能为空&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//密码不能为空</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(user.getPassword()))&#123;</span><br><span class="line">            map.put(<span class="string">&quot;passwordMsg&quot;</span>, <span class="string">&quot;密码不能为空&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//邮箱不能为空</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(user.getEmail()))&#123;</span><br><span class="line">            map.put(<span class="string">&quot;emailMsg&quot;</span>, <span class="string">&quot;邮箱不能为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//验证账号用户名是否存在</span></span><br><span class="line">        HashMap&lt;String, Object&gt; userMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        userMap.put(<span class="string">&quot;username&quot;</span>, user.getUsername());</span><br><span class="line">        List&lt;User&gt; userList = userMapper.selectByMap(userMap);</span><br><span class="line">        <span class="keyword">if</span> (userList.size()!=<span class="number">0</span>)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;usernameMsg&quot;</span>, <span class="string">&quot;账号已存在&quot;</span>);</span><br><span class="line">            System.out.println(userList);</span><br><span class="line">            System.out.println(user.getUsername()+<span class="string">&quot;: 此账号已存在&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//验证邮箱是否存在</span></span><br><span class="line">        HashMap&lt;String, Object&gt; userMail = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        userMail.put(<span class="string">&quot;email&quot;</span>, user.getEmail());</span><br><span class="line">        List&lt;User&gt; emailList = userMapper.selectByMap(userMail);</span><br><span class="line">        <span class="keyword">if</span> (emailList.size()!=<span class="number">0</span>)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;usernameMsg&quot;</span>, <span class="string">&quot;邮箱已被注册&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//注册用户,对密码加盐后进行md5加密</span></span><br><span class="line">        user.setSalt(CommunityUtil.getUUID().substring(<span class="number">0</span>,<span class="number">5</span>));</span><br><span class="line">        user.setPassword(CommunityUtil.md5(user.getPassword()+user.getSalt()));</span><br><span class="line">        user.setType(<span class="number">0</span>);    <span class="comment">//0 默认注册普通用户</span></span><br><span class="line">        user.setStatus(<span class="number">0</span>);  <span class="comment">//0 未激活</span></span><br><span class="line">        user.setActivationCode(CommunityUtil.getUUID());    <span class="comment">//设置随机的激活码</span></span><br><span class="line">        user.setHeaderUrl(String.format(<span class="string">&quot;https://images.nowcoder.com/head/%dt.png&quot;</span>, <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">1000</span>)));   <span class="comment">//随机头像</span></span><br><span class="line">        user.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="comment">//保存到数据库</span></span><br><span class="line">        userMapper.insert(user);</span><br><span class="line">        <span class="comment">//激活邮箱</span></span><br><span class="line">        <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Context</span>();</span><br><span class="line">        context.setVariable(<span class="string">&quot;email&quot;</span>, user.getEmail());</span><br><span class="line">        <span class="comment">//http://localhost:8080/activation/101/code</span></span><br><span class="line">        String url=domain+<span class="string">&quot;/activation/&quot;</span>+user.getId()+<span class="string">&quot;/&quot;</span>+user.getActivationCode();</span><br><span class="line">        context.setVariable(<span class="string">&quot;url&quot;</span>, url);</span><br><span class="line">        String content=templateEngine.process(<span class="string">&quot;/mail/activation&quot;</span>, context);</span><br><span class="line">        mailClient.sendMail(user.getEmail(), <span class="string">&quot;激活账户&quot;</span>, content);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">activation</span><span class="params">(<span class="type">int</span> userId, String code)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectById(userId);</span><br><span class="line">        <span class="keyword">if</span> (user.getStatus()==<span class="number">1</span>)&#123;   <span class="comment">//重复激活</span></span><br><span class="line">            <span class="keyword">return</span> ACTIVATION_REPEAT;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (user.getActivationCode().equals(code))&#123;</span><br><span class="line">            UpdateWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">UpdateWrapper</span>&lt;&gt;();</span><br><span class="line">            wrapper.set(<span class="string">&quot;status&quot;</span>, <span class="number">1</span>).eq(<span class="string">&quot;id&quot;</span>, userId);</span><br><span class="line">            userMapper.update(<span class="literal">null</span>, wrapper);</span><br><span class="line">            <span class="keyword">return</span> ACTIVATION_SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ACTIVATION_FAILURE;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在控制层,同样有注册以及激活账户的方法</p>
<p>注册方法就是调用service层中的方法,根据调用的结果,将相关的注册信息传递给视图层,比如说service层中map集合里面的一些提示,通过model传递给视图层,最终注册成功的话返回注册成功的页面,主要提示用户已经发送邮件到用户的邮箱</p>
<p>激活账户的方法,也是通过调用service层中的激活方法,根据激活结果的不同情况来进行不同的判断,比如说如果激活成功就会跳转到登录界面,如果重复激活或者激活失败就会跳转到首页,最终返回操作结果的界面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注册用户</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/register&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">register</span><span class="params">(Model model, User user)</span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = userService.register(user);</span><br><span class="line">        <span class="keyword">if</span> (map==<span class="literal">null</span> || map.isEmpty())&#123;</span><br><span class="line">            model.addAttribute(<span class="string">&quot;msg&quot;</span>,<span class="string">&quot;注册成功了,我们已经向您的邮箱发送了激活邮件,请尽快激活&quot;</span>);</span><br><span class="line">            model.addAttribute(<span class="string">&quot;target&quot;</span>,<span class="string">&quot;/index&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;/site/operate-result&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            model.addAttribute(<span class="string">&quot;usernameMsg&quot;</span>,map.get(<span class="string">&quot;usernameMsg&quot;</span>));</span><br><span class="line">            model.addAttribute(<span class="string">&quot;passwordMsg&quot;</span>,map.get(<span class="string">&quot;passwordMsg&quot;</span>));</span><br><span class="line">            model.addAttribute(<span class="string">&quot;emailMsg&quot;</span>,map.get(<span class="string">&quot;emailMsg&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;/site/register&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//激活账户</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/activation/&#123;userId&#125;/&#123;code&#125;&quot;)</span>    			        		<span class="comment">//http://localhost:8080/activation/101/code</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">activation</span><span class="params">(Model model,</span></span><br><span class="line"><span class="params">                             <span class="meta">@PathVariable(&quot;userId&quot;)</span> <span class="type">int</span> userId,    //从变量取值</span></span><br><span class="line"><span class="params">                             <span class="meta">@PathVariable(&quot;code&quot;)</span> String code)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">activation</span> <span class="operator">=</span> userService.activation(userId, code);</span><br><span class="line">        <span class="keyword">if</span> (activation==<span class="number">0</span>)&#123;     <span class="comment">//成功</span></span><br><span class="line">            model.addAttribute(<span class="string">&quot;msg&quot;</span>,<span class="string">&quot;激活成功,快点使用吧^_^&quot;</span>);</span><br><span class="line">            model.addAttribute(<span class="string">&quot;target&quot;</span>,<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (activation==<span class="number">1</span>)&#123;   <span class="comment">//重复</span></span><br><span class="line">            model.addAttribute(<span class="string">&quot;msg&quot;</span>,<span class="string">&quot;不要重复激活哦!&quot;</span>);</span><br><span class="line">            model.addAttribute(<span class="string">&quot;target&quot;</span>,<span class="string">&quot;/index&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;     <span class="comment">//失败</span></span><br><span class="line">            model.addAttribute(<span class="string">&quot;msg&quot;</span>,<span class="string">&quot;您输入的激活码可能不对哦!&quot;</span>);</span><br><span class="line">            model.addAttribute(<span class="string">&quot;target&quot;</span>,<span class="string">&quot;/index&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/operate-result&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="登录退出功能"><a href="#登录退出功能" class="headerlink" title="登录退出功能"></a>登录退出功能</h4><p>这里新建了一个表,主要是保存用户的凭证,主要的字段有用户id,用户凭证,用户状态,登录状态过期时间</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginTicket</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> Integer userId;</span><br><span class="line">    <span class="keyword">private</span> String ticket;</span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="keyword">private</span> Date expired;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>在业务层主要声明了三个相关的接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String,Object&gt; <span class="title function_">login</span><span class="params">(String username, String password, Integer expiredSeconds)</span>;</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">logout</span><span class="params">(String ticket)</span>;</span><br><span class="line">LoginTicket <span class="title function_">findLoginTicket</span><span class="params">(String ticket)</span>;</span><br></pre></td></tr></table></figure>

<ol>
<li>登录的接口: 返回一个Map集合,集合里面保存用户登录结果的一些具体信息,参数为用户名,密码,以及登录状态的过期时间</li>
<li>退出登录的接口:不返回内容,参数为用户登录</li>
<li>查询用户凭证是否存在的接口:可根据用户凭证到数据库中去查找这个凭证</li>
</ol>
<p>具体的实现:</p>
<ol>
<li>登录的实现<ul>
<li>一开始验证用户输入的图片验证码是否正确,验证码是保存在session中,通过从session中读取验证码,如果验证码为空,或者与session中验证码不等,那么将返回到登录界面</li>
<li>首先对用户的用户名,密码进行简单的判断,比如是否为空,如果为空的话,将相应的提示信息保存到map集合中</li>
<li>然后调用mapper层中方法区去判断用户名是否存在,如果不存在将提示信息保存到map集合中</li>
<li>接着对用户密码进行校验,因为在注册成功后保存到数据库中的密码信息是加密后的信息,也就是将用户的密码和随机生成的字符串进行了拼接,然后进行了md5加密处理,所以在校验密码的时候,同样需要进行加密处理,也就是取出用户表中密码后面拼接的字符串,与用户输入的密码进行拼接再进行加密比较.如果校验不正确,那么将错误信息保存到集合中</li>
<li>如果上面的步骤都正确,就要为用户生成一个登录凭证保存到这个凭证表中,这个凭证是一个随机生成的UUID,同时还要设置凭证的有效状态,0表示凭证有效,还有一个凭证的过期时间,当超过这个过期时间就要重新登录0</li>
<li>最后将这个用户凭存放到map集合中,如果一切都正常的话,map集合中只会有一个凭证的信息</li>
</ul>
</li>
<li>退出的实现: 比较简单,就是将用户登录凭证的状态设置为1,即表示退出</li>
<li>查询用户凭证是否存在的实现: 可根据用户凭证到数据库中去查找这个凭证</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">login</span><span class="params">(String username, String password, Integer expiredSeconds)</span> &#123;</span><br><span class="line">    HashMap&lt;String,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//空值判断</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(username))&#123;</span><br><span class="line">        map.put(<span class="string">&quot;usernameMsg&quot;</span>, <span class="string">&quot;用户名不能为空哦(⊙o⊙)…&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(password))&#123;</span><br><span class="line">        map.put(<span class="string">&quot;passwordMsg&quot;</span>, <span class="string">&quot;密码不能为空哦(⊙o⊙)…&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//登录校验</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectByName(username);</span><br><span class="line">    <span class="keyword">if</span> (user==<span class="literal">null</span>)&#123;</span><br><span class="line">        map.put(<span class="string">&quot;usernameMsg&quot;</span>, <span class="string">&quot;该账户不存在哦,仔细检查下吧(≧∇≦)ﾉ&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将加密后的密码进行验证</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">md5</span> <span class="operator">=</span> CommunityUtil.md5(password + user.getSalt());</span><br><span class="line">    <span class="comment">//输入的密码和查询到的不一致,密码错误</span></span><br><span class="line">    <span class="keyword">if</span> (!md5.equals(user.getPassword()))&#123;</span><br><span class="line">        map.put(<span class="string">&quot;usernameMsg&quot;</span>,<span class="string">&quot;密码错误哦,重新输入吧^_^&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//生成登录凭证</span></span><br><span class="line">    <span class="type">LoginTicket</span> <span class="variable">loginTicket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoginTicket</span>();</span><br><span class="line">    loginTicket.setUserId(user.getId());    <span class="comment">//用户id</span></span><br><span class="line">    loginTicket.setTicket(CommunityUtil.getUUID()); <span class="comment">//随机凭证</span></span><br><span class="line">    loginTicket.setStatus(<span class="number">0</span>);               <span class="comment">//账户状态 0 有效 1无效</span></span><br><span class="line">    loginTicket.setExpired(<span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis()+ expiredSeconds*<span class="number">1000</span>));</span><br><span class="line">    loginTicketMapper.insertTicket(loginTicket);    <span class="comment">///存入表中</span></span><br><span class="line">    map.put(<span class="string">&quot;ticket&quot;</span>, loginTicket.getTicket());     <span class="comment">//存入map集合中</span></span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logout</span><span class="params">(String ticket)</span> &#123;</span><br><span class="line">    loginTicketMapper.updateStatus(ticket, <span class="number">1</span>);  <span class="comment">//状态为1表示退出</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> LoginTicket <span class="title function_">findLoginTicket</span><span class="params">(String ticket)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> loginTicketMapper.selectByTicket(ticket);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<p><strong>在控制层中同样要有登录退出的方法</strong></p>
<p>登录方法的具体实现:</p>
<ol>
<li>首先判断输入的验证码是否和生成的验证码一致,如果不一致返回给视图对应的提示信息,并重新返回登录界面</li>
<li>然后通过调用service中的登录方法得到一个map集合<ul>
<li>如果map集合中有登录凭证的信息,那么我们将这个凭证保存到cookie中,设置cookie的过期的时间以及cookie的有效访问路径,将这个cookie保存到浏览器中,最终返回到首页</li>
<li>如果map集合中没有登录凭证的信息,那么久表示登录失败,通过model向页面传递相应的提示信息,最后放到登录界面</li>
</ul>
</li>
</ol>
<p>退出登录的方法:</p>
<p>通过<code>@CookieValue(&quot;ticket&quot;)</code>注解得到浏览器cookie中凭证的信息,调用service层中的退出方法,将用户的状态设置为无效,最终返回到登录界面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录的逻辑</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username      用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password      密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code          验证码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rememberMe    是否记住密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> model          Model模型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session       从session中取出验证码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response      保存到cookie中</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>              登录结果的页面</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(String username,String password,String code,<span class="type">boolean</span> rememberMe,</span></span><br><span class="line"><span class="params">                        Model model,HttpSession session,HttpServletResponse response)</span>&#123;</span><br><span class="line">        <span class="comment">//验证输入验证码是否一致</span></span><br><span class="line">        String kapthcha=(String) session.getAttribute(<span class="string">&quot;kaptcha&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(code)||StringUtils.isBlank(kapthcha)||!code.equalsIgnoreCase(kapthcha))&#123;</span><br><span class="line">            model.addAttribute(<span class="string">&quot;codeMsg&quot;</span>,<span class="string">&quot;验证码不正确哦,重新输入吧O(∩_∩)O哈哈~&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;/site/login&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//检查账号,密码</span></span><br><span class="line">        <span class="type">int</span> expiredSeconds=rememberMe?REMEMBER_EXPIRED_SECONDS:DEFAULT_EXPIRED_SECONDS; <span class="comment">//是否记住密码,有效期不一样</span></span><br><span class="line">        Map&lt;String, Object&gt; map = userService.login(username, password, expiredSeconds);</span><br><span class="line">        <span class="keyword">if</span> (map.containsKey(<span class="string">&quot;ticket&quot;</span>))&#123;         <span class="comment">//如果map中有ticket,则登录成功</span></span><br><span class="line">            <span class="type">Cookie</span> <span class="variable">cookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cookie</span>(<span class="string">&quot;ticket&quot;</span>, map.get(<span class="string">&quot;ticket&quot;</span>).toString());  <span class="comment">//将凭证存入cookie</span></span><br><span class="line">           <span class="comment">// cookie.setPath(&quot;&quot;);                 //设置cookie的路径</span></span><br><span class="line">            cookie.setMaxAge(expiredSeconds);     <span class="comment">//设置过期时间</span></span><br><span class="line">            response.addCookie(cookie);           <span class="comment">//添加cookie</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;redirect:/index&quot;</span>;             <span class="comment">//返回首页</span></span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;     <span class="comment">//登录失败,提示错误信息,返回登录页面</span></span><br><span class="line">            model.addAttribute(<span class="string">&quot;usernameMsg&quot;</span>,map.get(<span class="string">&quot;usernameMsg&quot;</span>));</span><br><span class="line">            model.addAttribute(<span class="string">&quot;passwordMsg&quot;</span>,map.get(<span class="string">&quot;passwordMsg&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;/site/login&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/logout&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">logout</span><span class="params">(<span class="meta">@CookieValue(&quot;ticket&quot;)</span> String ticket)</span>&#123;</span><br><span class="line">        userService.logout(ticket);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:/login&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="验证码"><a href="#验证码" class="headerlink" title="验证码"></a>验证码</h4><p>在登录的时候为了放置恶意频繁地登录,要求用户输入账号密码后还需要输入对应的验证码,只有验证码正确之后才会从数据库中查询数据</p>
<p>在项目中整合了谷歌的kaptcha随机验证码插件,生成随机验证码的方法声明在一个配置类,交给spring管理,方便以后的使用</p>
<p>在控制层通过配置类可以得到验证码里面的数字以及验证码的图片,然后将这个数字保存在session中,将这个图片通过response获取字节输出流,然后通过<code>ImageIO</code>这个工具通过字节流的方式给浏览器输出图片</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/kaptcha&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getKaptcha</span><span class="params">(HttpServletResponse response,HttpSession session)</span>&#123;</span><br><span class="line">        <span class="comment">//生成验证码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> kaptchaProducer.createText();</span><br><span class="line">        <span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> kaptchaProducer.createImage(text);</span><br><span class="line">        <span class="comment">//将验证码存入session</span></span><br><span class="line">        session.setAttribute(<span class="string">&quot;kaptcha&quot;</span>, text);</span><br><span class="line">        <span class="comment">//将图片传给浏览器</span></span><br><span class="line">        response.setContentType(<span class="string">&quot;image/png&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">            ImageIO.write(image, <span class="string">&quot;png&quot;</span>, os);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;相应验证码失败了: &quot;</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="显示登录信息"><a href="#显示登录信息" class="headerlink" title="显示登录信息"></a>显示登录信息</h4><p>定义拦截器,实现HandlerInterceptor</p>
<p>配置拦截器,为;它指定拦截,排除的路径</p>
<p>拦截器的应用:</p>
<p>在请求开始时查询登录用户<br>在本次请求中持有用户数据<br>在模板视图上显示用户数据<br>在请求结束时清理用户数据</p>
<ol>
<li>首先定义登录的拦截器,实现HandlerInterceptor接口,重写里面的三个方法,也就是<code>preHandler</code>,<code>postHandle</code>,以及<code>afterCompletion</code></li>
<li><strong><code>preHandler</code>是在控制层的方法执行前就生效进行拦截</strong><ul>
<li>首先从cookie中获取用户的凭证信息,这个凭证信息是在用户登录成功后保存到浏览器的cookie中的</li>
<li>然后去数据库中用户凭证的状态,如果能够查询到用户凭证的信息并且用户凭证的状态不为0,也就是有效的并且查询的时候凭证还未过期</li>
<li>那么就要通过用户凭证表中的用户id去用户表中查询用户的信息,最后将用户信息保存到ThrealLocal中<ul>
<li>不保存在session中是因为在分布式的环境下,使用session存在共享数据的问题,所以应该是将共享数据存入redis中，所有的应用服务器都去redis中获取共享数据</li>
<li>这个项目比较简单,所以拦截器这边没有使用redis进行处理,而是使用ThrealLocl进行处理,对于每一次请求，开始时从数据库里取到数据，然后将其临时存放在本地的内存里，因为考虑到线程之间的隔离，所以用threadlocal，这样在本次请求的过程中，就可以随时获取到这份共享数据了。</li>
</ul>
</li>
</ul>
</li>
<li><strong><code>postHandle</code>在模板引擎执行前执行,主要是取出ThreadLocal中的值</strong></li>
<li><strong><code>afterCompletion</code>所有方法执行结束之后执行,移除ThreadLocal中的值</strong></li>
<li>在声明了拦截器之后,需要在配置类中去进行注册配置拦截器,指定拦截器需要拦截的路径以及需要排除的路径</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在controller方法调用前执行</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, 	     Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//从cookie中获取凭证</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">ticket</span> <span class="operator">=</span> CookieUtil.getValue(request, <span class="string">&quot;ticket&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (ticket!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//查询数据库中的凭证</span></span><br><span class="line">            <span class="type">LoginTicket</span> <span class="variable">loginTicket</span> <span class="operator">=</span> userService.findLoginTicket(ticket);</span><br><span class="line">            <span class="comment">//检查凭证是否有效,当凭证存在,切状态为0(有效),且过期时间实在现在时间之后才有效</span></span><br><span class="line">            <span class="keyword">if</span> (loginTicket!=<span class="literal">null</span>&amp;&amp;loginTicket.getStatus()==<span class="number">0</span>&amp;</span><br><span class="line">                    loginTicket.getExpired().after(<span class="keyword">new</span> <span class="title class_">Date</span>()))&#123;</span><br><span class="line">                <span class="comment">//根据凭证查询用户id,然后根据用户id查询用户</span></span><br><span class="line">                <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(loginTicket.getUserId());</span><br><span class="line">                <span class="comment">//在本次请求中持有用户,将其存放在ThreadLocal中</span></span><br><span class="line">                hostHolder.setUser(user);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在模板引擎执行前执行,取出ThreadLocal中的值</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response,         Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> hostHolder.getUser();</span><br><span class="line">        <span class="keyword">if</span> (user!=<span class="literal">null</span>&amp;&amp;modelAndView!=<span class="literal">null</span>)&#123;</span><br><span class="line">            modelAndView.addObject(<span class="string">&quot;loginUser&quot;</span>,user);   <span class="comment">//将登录信息存放在ModelAndView中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//所有方法执行结束之后执行</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response,     Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        hostHolder.remove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(interceptor)</span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/**/*.css&quot;</span>,<span class="string">&quot;/**/*.png&quot;</span>,<span class="string">&quot;/**/*.jpg&quot;</span>,<span class="string">&quot;/**/*.jpeg&quot;</span>)</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/register&quot;</span>,<span class="string">&quot;/login&quot;</span>);</span><br><span class="line"></span><br><span class="line">        registry.addInterceptor(loginInterceptor)</span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/**/*.css&quot;</span>,<span class="string">&quot;/**/*.png&quot;</span>,<span class="string">&quot;/**/*.jpg&quot;</span>,<span class="string">&quot;/**/*.jpeg&quot;</span>);</span><br><span class="line"></span><br><span class="line">        registry.addInterceptor(loginRequiredInterceptor)</span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/**/*.css&quot;</span>,<span class="string">&quot;/**/*.png&quot;</span>,<span class="string">&quot;/**/*.jpg&quot;</span>,<span class="string">&quot;/**/*.jpeg&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="账号设置"><a href="#账号设置" class="headerlink" title="账号设置"></a>账号设置</h4><p>用户账号设置主要包括更换头像,修改用户密码</p>
<p><strong>更换头像</strong></p>
<ol>
<li>更换头像的主要逻辑实在控制层,在持久层和业务层的实现是比较简单的,也就是一个根据用户名更新头像的SQL语句</li>
<li>在控制层要使用post方法进行提交,首先判断传入的图片是否为空,如果为空的话,向通过model向页面传递相关的错误提示信息,并返回到更换头像的页面</li>
<li>然后对传入的文件进行随机命名,先截取到图片的后缀,然后生成随机的文件名再拼接上图片后缀名</li>
<li>接着确定文件的存储位置,一开始是存放在本地内存中的</li>
<li>然后要更新用户表中的头像路径,这里的路径是服务端的路径,也就是和显示头像方法中的路径摇一摇,就要是新声明一个图片的访问路径去显示对应的头像</li>
<li>最终重定向到首页</li>
</ol>
<p><strong>显示头像</strong></p>
<ol>
<li>在浏览器显示头像的方法,首先要获取本地图片存储的路径,获取文件的后缀名</li>
<li>然后给浏览器响应对应的图片格式,也就是上一步的后缀名</li>
<li>接着通过输入输出流向浏览器发送图片,最终展示在浏览器中<ul>
<li>首先获取一个文件输入流,从本地向服务器输入,保存在buffer中</li>
<li>接着通过response获取输出字节流,将buffer中的数据写出响应给浏览器</li>
</ul>
</li>
</ol>
<p><strong>修改密码</strong></p>
<ol>
<li><p>在业务层中声明更新密码的接口,返回Map集合,用于保存用户的修改密码结果的一些信息,参数是用户id,旧密码,新密码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String,Object&gt;  <span class="title function_">updatePassword</span><span class="params">(Integer userId,String oldPassword,String newPassword)</span>;</span><br></pre></td></tr></table></figure>

<p>接口的实现中</p>
<ul>
<li>首先进行简单判断,判断原密码新密码是否为空,如果为空将对应的提示信息保存到Map集合中</li>
<li>然后通过用户名去数据库中查询密码,将用户输入的密码与查询到的密码进行比较,这里要注意数据库中保存的密码是加密后的结果,我们也要对用户输入的密码进行加密处理<ul>
<li>在加密的时候,使用的是md5进行加密,为了进一步提高安全性,对原密码后面拼接一个随机的字符串,然后在进行加密</li>
<li>在比较的时候,我们还需要先取出用户拼接的字符串,这个在数据库中是一个字段,架构用户输入的密码与取出的字符串进行拼接处理,然后进行加密,得到的值与数据库中的值进行比较</li>
</ul>
</li>
<li>如果两者相等,那么就更新用户的密码,将加密后的密码存储在数据库中</li>
</ul>
</li>
<li><p>在控制层中</p>
<ul>
<li>在方法的参数中传入<code>@CookieValue</code>注解的参数,可以得到用户的凭证,作为参数传递到方法中</li>
<li>然后由于当前的访问还未过期,可以直接从ThreadLocal中取出当前的用户,通过用户得到用户id,用户的加密盐.也就是密码后面拼接的字符串,对这个旧密码进行加密处理,然后调用业务层的方法进行修改</li>
<li>如果map集合为空,那么就修改成功,将用户退出,返回到登录界面,这里的退出方法调用的是另一个控制层的退出方法</li>
</ul>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title function_">updatePassword</span><span class="params">(Integer userId,String oldPassword,String newPassword)</span> &#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  <span class="comment">//保存相关的信息</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(oldPassword))&#123;</span><br><span class="line">            map.put(<span class="string">&quot;passwordMsg&quot;</span>,<span class="string">&quot;原密码不能为空哦&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(newPassword))&#123;</span><br><span class="line">            map.put(<span class="string">&quot;passwordMsg&quot;</span>,<span class="string">&quot;新密码也不能为空哦&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//验证原密码,根据用户id取出原密码</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectById(userId);</span><br><span class="line">        String oldMD5=CommunityUtil.md5(oldPassword+user.getSalt());</span><br><span class="line">        log.info(<span class="string">&quot;输入的旧密码是: &#123;&#125;&quot;</span>,oldPassword);</span><br><span class="line">        log.info(<span class="string">&quot;加密后的旧密码是: &#123;&#125;&quot;</span>,oldMD5);</span><br><span class="line">        log.info(<span class="string">&quot;数据库加密密码是: &#123;&#125;&quot;</span>,user.getPassword());</span><br><span class="line">        <span class="keyword">if</span> (!oldMD5.equals(user.getPassword()))&#123;</span><br><span class="line">            map.put(<span class="string">&quot;passwordMsg&quot;</span>, <span class="string">&quot;原密码不正确哦,重新输入吧~(^o^)~&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//保存新的密码</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> userMapper.updatePassword(userId, newPassword);</span><br><span class="line">        <span class="keyword">if</span> (res!=<span class="number">1</span>)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;passwordMsg&quot;</span>,<span class="string">&quot;出现了未知的错误,┭┮﹏┭┮&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/updatePassword&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">updatePassword</span><span class="params">(Model model,String oldPassword,String password,</span></span><br><span class="line"><span class="params">                                 <span class="meta">@CookieValue(&quot;ticket&quot;)</span> String ticket)</span>&#123;</span><br><span class="line">        <span class="comment">//从ThreadLocal中先取出当前的用户</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> hostHolder.getUser();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">userId</span> <span class="operator">=</span> user.getId();</span><br><span class="line">        <span class="comment">//加密盐这里使用旧的</span></span><br><span class="line">        String salt=user.getSalt();</span><br><span class="line">        String newPassword=CommunityUtil.md5(password+salt);</span><br><span class="line">        Map&lt;String, Object&gt; map = 		            userService.updatePassword(userId,oldPassword,newPassword);</span><br><span class="line">        System.out.println(map);</span><br><span class="line">        <span class="comment">//修改成功,返回登录界面</span></span><br><span class="line">        <span class="keyword">if</span> (map==<span class="literal">null</span>||map.isEmpty())&#123;</span><br><span class="line">            <span class="keyword">return</span> loginController.logout(ticket);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//修改失败,返回修改界面</span></span><br><span class="line">            model.addAttribute(<span class="string">&quot;passwordMsg&quot;</span>,map.get(<span class="string">&quot;passwordMsg&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;/site/setting&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="检查登录状态"><a href="#检查登录状态" class="headerlink" title="检查登录状态"></a>检查登录状态</h4><p>为了防止普通用户通过特殊的途径去访问一些不能访问的资源,比如说还没有登录,通过url路径直接去访问修改密码的页面,这就需要进行判断</p>
<p>可以通过拦截器</p>
<ul>
<li>在方法前面标注一个自定义的注解</li>
<li>拦截所有的请求,只处理带有该注解的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*自定义一个注解*/</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> LoginRequired &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HostHolder hostHolder;</span><br><span class="line">    <span class="comment">//在方法前进行拦截处理</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//判断拦截的目标是不是方法,只有方法才进行拦截</span></span><br><span class="line">        <span class="keyword">if</span> (handler <span class="keyword">instanceof</span> HandlerMethod)&#123;</span><br><span class="line">            HandlerMethod handlerMethod=(HandlerMethod) handler;</span><br><span class="line">            <span class="comment">//获得这个方法,从这个方法中去取注解</span></span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> handlerMethod.getMethod();</span><br><span class="line">            <span class="type">LoginRequired</span> <span class="variable">loginRequired</span> <span class="operator">=</span> method.getAnnotation(LoginRequired.class);</span><br><span class="line">            <span class="comment">//这个注解需要存在并且要存在登录的状态,否则的话返回到登录界面</span></span><br><span class="line">            <span class="keyword">if</span> (loginRequired!=<span class="literal">null</span>&amp;&amp;hostHolder.getUser()==<span class="literal">null</span>)&#123;</span><br><span class="line">                response.sendRedirect(request.getContextPath()+<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-开发社区核心功能"><a href="#3-开发社区核心功能" class="headerlink" title="3.开发社区核心功能"></a>3.开发社区核心功能</h3><h4 id="过滤敏感词"><a href="#过滤敏感词" class="headerlink" title="过滤敏感词"></a>过滤敏感词</h4><p>为了避免用户发布一些敏感词汇,使用前缀树将文本中的敏感词进行过滤</p>
<ol>
<li>首先声明一个前缀树,前缀树中的根节点没有值,其他的每层的一个子节点都存储着敏感词的一个字符,也就是说将每一个敏感词划分成一个个字符,纵向存储在前缀树的每一个节点上面</li>
<li>具体流程是先将一个敏感词分割为一个个字符,进行循环处理,看树种是否已经存在待添加的节点,如果还没有就进行添加,添加之后将节点指向刚添加的节点,进入下一轮循环.同时还需要设置一个结束的标志,表示这个节点的字符是敏感词的最后一个词.</li>
<li>过滤的流程:<ul>
<li>首先声明3个指针,指针1一个指向树的根节点,也就是遍历存放在树种的字符,指针2和指针3一开始都指向文本的开始</li>
<li>首先根据敏感词的字符得到树的下一个节点,如果这个节点为空的话,那么就证明以这个指针2开头的字符不是敏感词,把这个字符记录下来</li>
<li>然后让指针2与指针3后移一位,得到下一个字符</li>
<li>如果发现一个字符在树节点中存在,那么以这个字符开头的字符就可能是敏感词<ul>
<li>接着需要移动指针3,看下一个节点中是否有指针3指向的值</li>
<li>如果有的话并且这个是敏感词的结尾字符,那么将这个字符变为*进行记录</li>
<li>如果不是敏感词的结尾时,继续让指针3右移,重复上面的操作</li>
</ul>
</li>
<li>当发现树中没有指针3指向的字符,那么证明指针2到指针3这个范围的字符不是敏感词,让指针2右移,重复上面的操作</li>
<li>当指针2走到文本末尾的时候结束循环,输出新的文本内容</li>
</ul>
</li>
</ol>
<p><img src="C:\Users\张哲\AppData\Roaming\Typora\typora-user-images\1651847873490.png" alt="1651847873490"></p>
<h4 id="发布帖子"><a href="#发布帖子" class="headerlink" title="发布帖子"></a>发布帖子</h4><ol>
<li>在持久层是一个新增帖子的方法,SQL语句也就是向帖子表中插入数据</li>
<li>在业务层就是调用持久层的方法,实现添加的功能,为了对文本做了一些过滤判断的行为,比如说如果用户输入了标签,那么就要对标签进行转义,不让它在页面生效,还有对标题和文本进行敏感词过滤</li>
<li>控制层的话以post方式提交数据,在页面使用ajax异步提交的方式将增量呈现在数据上,而不需要刷新整个页面,这里返回的是一个json字符串,内容是一些提示的信息,在前端js能够进行调用</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/add&quot;)</span></span><br><span class="line">  <span class="meta">@ResponseBody</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">addDiscussPost</span><span class="params">(String title,String content)</span>&#123;</span><br><span class="line">      <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> hostHolder.getUser();</span><br><span class="line">      <span class="keyword">if</span> (user==<span class="literal">null</span>)&#123;</span><br><span class="line">          <span class="keyword">return</span> CommunityUtil.getJsonString(<span class="number">403</span>, <span class="string">&quot;您还没有登录&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="type">DiscussPost</span> <span class="variable">discussPost</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DiscussPost</span>();</span><br><span class="line">      discussPost.setUserId(user.getId());</span><br><span class="line">      discussPost.setTitle(title);</span><br><span class="line">      discussPost.setContent(content);</span><br><span class="line">      discussPost.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">      discussPostService.addDiscussPost(discussPost);</span><br><span class="line">      <span class="keyword">return</span> CommunityUtil.getJsonString(<span class="number">0</span>, <span class="string">&quot;发布成功&quot;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="帖子详情"><a href="#帖子详情" class="headerlink" title="帖子详情"></a>帖子详情</h4><p>实现较为简单,也就是到数据库中根据帖子的id去查询,将帖子内容显示到页面上去,其中帖子id在之前首页显示的时候已经查询过,封装在了map集合中,可以直接取出使用进行查询</p>
<p>根据帖子的id去拿到用户名,这里是调用业务层与用户相关的方法去根据用户名查询用户名</p>
<hr>
<h4 id="显示评论"><a href="#显示评论" class="headerlink" title="显示评论"></a>显示评论</h4><p><strong>持久层</strong></p>
<ol>
<li>根据实体(文章,帖子或者评论)查询一页评论的数据</li>
<li>根据实体查询评论的数量</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Comment&gt; <span class="title function_">selectCommentByEntity</span><span class="params">(Integer entityType,Integer entityId,Integer 		offset,Integer limit)</span>;</span><br><span class="line">   Integer <span class="title function_">selectCountByEntity</span><span class="params">(Integer entityType,Integer entityId)</span>;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>业务层</strong></p>
<ol>
<li>处理查询评论的业务</li>
<li>处理查询评论数量的业务</li>
</ol>
<p>直接调用持久层的方法即可</p>
<hr>
<p><strong>表现层</strong></p>
<p>显示帖子详情数据,同时显示该帖子所有的评论数据</p>
<ol>
<li>评论的地方主要是在帖子的详情页面,所以是在帖子的详情页面开发与评论相关的功能</li>
<li>因为评论主要有针对帖子的评论,以及针对评论的评论,为了开发方便就把这些数据全都封装到了一个集合中,方便前端进行调用</li>
<li>首先根据业务层的方法找到针对帖子的评论信息,遍历这些评论,将这些评论的内容以及评论的发布者封装进一个map中</li>
<li>然后在遍历针对帖子的评论的同时还需要找到针对评论的评论,遍历这些评论,将评论的内容,评论的发布者,以及对谁评论的信息,封装到一个map中,内存遍历完,将这个关于评论的评论的map添加到第一个map中</li>
<li>最后将这些map封装为一个结合,通过model发送给前端页面</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/detail/&#123;discussPostId&#125;&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">getDetailDiscuss</span><span class="params">(<span class="meta">@PathVariable</span> Integer discussPostId, Model model, Page page)</span>&#123;</span><br><span class="line">       <span class="comment">//帖子</span></span><br><span class="line">       <span class="type">DiscussPost</span> <span class="variable">post</span> <span class="operator">=</span> discussPostService.findDiscussById(discussPostId);</span><br><span class="line">       model.addAttribute(<span class="string">&quot;post&quot;</span>,post);</span><br><span class="line">       <span class="comment">//作者</span></span><br><span class="line">       <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(post.getUserId());</span><br><span class="line">       model.addAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">       <span class="comment">//评论的分页信息</span></span><br><span class="line">       page.setLimit(<span class="number">5</span>);   <span class="comment">//一页显示评论数量</span></span><br><span class="line">       page.setPath(<span class="string">&quot;/discuss/detail/&quot;</span>+discussPostId);</span><br><span class="line">       page.setRows(post.getCommentCount());   <span class="comment">//帖子下面评论的总数量</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         评论: 给帖子的评论</span></span><br><span class="line"><span class="comment">         回复: 给评论的评论</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">       <span class="comment">//找到帖子评论的集合</span></span><br><span class="line">       List&lt;Comment&gt; commentList = commentService.findCommentByEntity(</span><br><span class="line">               <span class="number">1</span>, post.getId(), page.getOffset(), page.getLimit());</span><br><span class="line">       <span class="comment">//帖子评论的列表,保存评论相关内容到这个列表中</span></span><br><span class="line">       ArrayList&lt;Map&lt;String, Object&gt;&gt; commentVoList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">       <span class="comment">//如果帖子的评论不为空,遍历这些评论,将评论相关的信息放到map中</span></span><br><span class="line">       <span class="keyword">if</span> (commentList!=<span class="literal">null</span>)&#123;</span><br><span class="line">           <span class="keyword">for</span> (Comment comment:commentList) &#123;</span><br><span class="line">               HashMap&lt;String, Object&gt; commentMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">               commentMap.put(<span class="string">&quot;comment&quot;</span>,comment); <span class="comment">//评论的内容</span></span><br><span class="line">               commentMap.put(<span class="string">&quot;user&quot;</span>, userService.findUserById(comment.getUserId())); <span class="comment">//作者</span></span><br><span class="line"></span><br><span class="line">               <span class="comment">//找到所有回复(也就是针对一个评论下面的所有评论)</span></span><br><span class="line">               List&lt;Comment&gt; replyList = commentService.findCommentByEntity(</span><br><span class="line">                       <span class="number">2</span>, comment.getId(), <span class="number">0</span>, Integer.MAX_VALUE);</span><br><span class="line">               <span class="comment">//记录回复的VO列表</span></span><br><span class="line">               ArrayList&lt;Map&lt;String, Object&gt;&gt; replyVoList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">               <span class="keyword">if</span> (replyList!=<span class="literal">null</span>) &#123;</span><br><span class="line">                   <span class="comment">//如果回复不为空,遍历这些回复,将回复相关的信息放到另一个map中</span></span><br><span class="line">                   <span class="keyword">for</span> (Comment reply : replyList) &#123;</span><br><span class="line">                       HashMap&lt;String, Object&gt; replyMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                       replyMap.put(<span class="string">&quot;reply&quot;</span>, reply);   <span class="comment">//回复的内容</span></span><br><span class="line">                       replyMap.put(<span class="string">&quot;user&quot;</span>, userService.findUserById(reply.getUserId()));  <span class="comment">//回复的作者</span></span><br><span class="line">                       <span class="type">User</span> <span class="variable">target</span> <span class="operator">=</span> reply.getTargetId() == <span class="number">0</span> ? <span class="literal">null</span> : userService.findUserById(reply.getUserId());</span><br><span class="line">                       replyMap.put(<span class="string">&quot;target&quot;</span>, target); <span class="comment">//回复的目标,回复哪个用户</span></span><br><span class="line">                       <span class="comment">//保存给回复的集合</span></span><br><span class="line">                       replyVoList.add(replyMap);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">//将回复的结合也存放在评论的大集合里面</span></span><br><span class="line">               commentMap.put(<span class="string">&quot;replys&quot;</span>,replyVoList);</span><br><span class="line">               <span class="comment">//一个评论下面回复的数量</span></span><br><span class="line">               <span class="type">Integer</span> <span class="variable">replyCount</span> <span class="operator">=</span> commentService.findCountByEntity(<span class="number">2</span>, comment.getId());</span><br><span class="line">               commentMap.put(<span class="string">&quot;replyCount&quot;</span>, replyCount);</span><br><span class="line">               commentVoList.add(commentMap);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//将所有评论相关的信息返回给视图层</span></span><br><span class="line">       model.addAttribute(<span class="string">&quot;comments&quot;</span>,commentVoList);</span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;/site/discuss-detail&quot;</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="添加评论"><a href="#添加评论" class="headerlink" title="添加评论"></a>添加评论</h4><p>bug:对评论进行回复,前端点击按钮一直失效,应该是传参时出错?暂时没有找出来</p>
<p>数据层: 增加评论,修改帖子评论数量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Integer <span class="title function_">insertComment</span><span class="params">(Comment comment)</span>;</span><br><span class="line">Integer <span class="title function_">updateCommentCount</span><span class="params">(Integer id,Integer commentCount)</span>;</span><br></pre></td></tr></table></figure>

<p>业务层: 处理添加评论的业务,先增加评论,再更新帖子评论数量</p>
<p>注意添加评论的同时进行敏感词过滤,添加评论之后,要去更新帖子表中的评论数量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//设置隔离级别</span></span><br><span class="line">    <span class="meta">@Transactional(isolation = Isolation.READ_COMMITTED,propagation = Propagation.REQUIRED)</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">addComment</span><span class="params">(Comment comment)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (comment==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span>  <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;参数不能为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//添加评论</span></span><br><span class="line">        comment.setContent(HtmlUtils.htmlEscape(comment.getContent()));</span><br><span class="line">        comment.setContent(sensitiveFilter.filter(comment.getContent()));</span><br><span class="line">        <span class="type">int</span> <span class="variable">rows</span> <span class="operator">=</span> commentMapper.insertComment(comment);</span><br><span class="line">        <span class="comment">//更新帖子的评论的数量</span></span><br><span class="line">        <span class="keyword">if</span> (comment.getEntityType()==<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="type">int</span> count=commentMapper.selectCountByEntity(comment.getEntityType(), comment.getEntityId());</span><br><span class="line">            discussPostService.updateCommentCount(comment.getEntityId(), count);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rows;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>表现层:处理添加评论的请求,设置添加评论的表单</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/add/&#123;discussPostId&#125;&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">addComment</span><span class="params">(<span class="meta">@PathVariable(&quot;discussPostId&quot;)</span> Integer discussPostId, Comment comment)</span>&#123;</span><br><span class="line">       comment.setUserId(hostHolder.getUser().getId());</span><br><span class="line">       comment.setStatus(<span class="number">0</span>);</span><br><span class="line">       comment.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">       commentService.addComment(comment);</span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;redirect:/discuss/detail/&quot;</span>+discussPostId;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="私信功能"><a href="#私信功能" class="headerlink" title="私信功能"></a>私信功能</h4><p>私信列表: 查询当前用户的会话列表:每一个会话只显示一条最新的私信;支持分页显示</p>
<p>私信详情:支持查询某个会话所包含的详情;支持分页查询</p>
<p><strong>数据层</strong></p>
<p>数据层是这次开发的难点,主要声明了五个方法</p>
<ol>
<li><p><strong>查询当前用户的会话列表,并且每一个会话都显示最新的一条消息</strong></p>
<p>这个主要在写sql语句的时候有些困难,因为私信只是使用了一个表,发消息的人,收消息的人,会话的id都在这个表中,如果想要查询到所有会话,并且会话都展示最新的一条消息,就要使用子查询,根据子查询得到的最新消息id,来得到所有会话列表,同时会话列表显示最新的消息,其中针对每一个会话得到最新消息,是使用聚合函数max,因为设置消息的id递增,每个会话里面最大的id就是最新的消息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> &lt;sql id=&quot;selectFields&quot;&gt;</span><br><span class="line">       id,from_id,to_id,conversation_id,content,status,create_time</span><br><span class="line"> &lt;/sql&gt;</span><br><span class="line">select &lt;include refid=&quot;selectFields&quot;/&gt;</span><br><span class="line">        from message</span><br><span class="line">        WHERE id IN(</span><br><span class="line">                SELECT MAX(id)</span><br><span class="line">                FROM message</span><br><span class="line">                WHERE STATUS!=2 AND from_id!=1</span><br><span class="line">                AND (from_id=#&#123;userId&#125; OR to_id=#&#123;userId&#125;)</span><br><span class="line">                GROUP BY conversation_id</span><br><span class="line">                )</span><br><span class="line">        ORDER BY create_time DESC</span><br><span class="line">        limit #&#123;offset&#125;, #&#123;limit&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>查询当前用户会话的数量</strong></p>
<p>当前用户的会话数量就是根据上次查询到会后列表作为子表,查询一下数量就可以了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">select count(m.maxid)</span><br><span class="line">        from (</span><br><span class="line">            SELECT MAX(id) as maxid</span><br><span class="line">            FROM message</span><br><span class="line">            WHERE STATUS!=2 AND from_id!=1</span><br><span class="line">            AND (from_id=#&#123;userId&#125; OR to_id=#&#123;userId&#125;)</span><br><span class="line">            GROUP BY conversation_id</span><br><span class="line">            ) as m</span><br></pre></td></tr></table></figure></li>
<li><p><strong>查询一个会话的消息的详情</strong></p>
<p>根据会话的id直接进行查询就可以了,其中会话的id是一个组合的字段,里面的信息包括了发消息人与收消息人的id,中间以下划线进行分割</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT &lt;include refid=&quot;selectFields&quot;/&gt;</span><br><span class="line">        FROM message</span><br><span class="line">        WHERE STATUS!=2 AND from_id!=1 AND conversation_id = #&#123;conversationId&#125;</span><br><span class="line">        order by id desc</span><br><span class="line">        limit #&#123;offset&#125;,#&#123;limit&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>查询一个会话中消息的数量</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select count(1)</span><br><span class="line">      from message</span><br><span class="line">      WHERE STATUS!=2 AND from_id!=1</span><br><span class="line">      AND conversation_id = #&#123;conversationId&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>查询当前用户未读消息的数量</strong></p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT COUNT(1)</span><br><span class="line">      FROM message</span><br><span class="line">      WHERE status=0 AND from_id!=1</span><br><span class="line">      AND to_id=#&#123;userId&#125;</span><br><span class="line">      &lt;if test=&quot;conversationId!=null&quot;&gt;</span><br><span class="line">          AND conversation_id =#&#123;conversationId&#125;</span><br><span class="line">      &lt;/if&gt;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>业务层</strong></p>
<p>实现简单,直接调用持久层中的方法即可</p>
<hr>
<p><strong>表现层</strong></p>
<p>通过调用业务层的方法,将得到的私信相关的内容封装到map集合中,发送给前端界面,封装的数据主要有每一个会话的信息,每一个会话里面消息的总数,每个会话未读消息的数量以及显示对方的头像,最后返回会话详情页面</p>
<p>显示私信的列表和显示会话的列表的实现逻辑基本一样,也是遍历每一天消息,将消息封装到map集合中传递给前端,主要封装的内容有私信的详情,以及私信的目标,最后返回私信详情页面</p>
<p>发送私信,通过设置设置消息的内容异步向服务器发送数据,将这个消息相关的信息保存到数据库当中.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageService messageService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HostHolder hostHolder;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//私信列表</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/letter/list&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLetterList</span><span class="params">(Model model, Page page)</span>&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> hostHolder.getUser();</span><br><span class="line">        <span class="comment">//分页信息</span></span><br><span class="line">        page.setLimit(<span class="number">5</span>);</span><br><span class="line">        page.setPath(<span class="string">&quot;/letter/list&quot;</span>);</span><br><span class="line">        page.setRows(messageService.findConversationCount(user.getId()));</span><br><span class="line">        <span class="comment">//会话列表</span></span><br><span class="line">        List&lt;Message&gt; conversationList=messageService.findConversations(</span><br><span class="line">                user.getId(), page.getOffset(), page.getLimit());</span><br><span class="line">        ArrayList&lt;Map&lt;String, Object&gt;&gt; conversations = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (conversationList!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (Message message:conversationList)&#123;</span><br><span class="line">                HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                <span class="comment">//会话信息</span></span><br><span class="line">                map.put(<span class="string">&quot;conversation&quot;</span>, message);</span><br><span class="line">                <span class="comment">//一个会话的私信数量</span></span><br><span class="line">                map.put(<span class="string">&quot;letterCount&quot;</span>, messageService.findLetterCount(message.getConversationId()));</span><br><span class="line">                <span class="comment">//未读的消息数</span></span><br><span class="line">                map.put(<span class="string">&quot;unreadCount&quot;</span>,messageService.findLetterUnreadCount(user.getId(), message.getConversationId()));</span><br><span class="line">                <span class="comment">//显示对话目标的头像</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">targetId</span> <span class="operator">=</span> user.getId() ==message.getFromId() ? message.getToId() : message.getFromId();</span><br><span class="line">                map.put(<span class="string">&quot;target&quot;</span>, userService.findUserById(targetId));</span><br><span class="line">                conversations.add(map);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;conversations&quot;</span>,conversations);</span><br><span class="line">        <span class="comment">//查询未读会话数量</span></span><br><span class="line">        <span class="type">int</span> letterUnreadCount=messageService.findLetterUnreadCount(user.getId(),<span class="literal">null</span>);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;letterUnreadCount&quot;</span>,letterUnreadCount);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/letter&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//私信详情列表</span></span><br><span class="line">    <span class="meta">@GetMapping(path = &quot;/letter/detail/&#123;conversationId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLetterDetail</span><span class="params">(<span class="meta">@PathVariable(&quot;conversationId&quot;)</span> String conversationId, Page page, Model model)</span> &#123;</span><br><span class="line">        <span class="comment">// 分页信息</span></span><br><span class="line">        page.setLimit(<span class="number">5</span>);</span><br><span class="line">        page.setPath(<span class="string">&quot;/letter/detail/&quot;</span> + conversationId);</span><br><span class="line">        page.setRows(messageService.findLetterCount(conversationId));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 私信列表</span></span><br><span class="line">        List&lt;Message&gt; letterList = messageService.findLetters(conversationId, page.getOffset(), page.getLimit());</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; letters = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (letterList != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Message message : letterList) &#123;</span><br><span class="line">                Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                map.put(<span class="string">&quot;letter&quot;</span>, message);</span><br><span class="line">                map.put(<span class="string">&quot;fromUser&quot;</span>, userService.findUserById(message.getFromId()));</span><br><span class="line">                letters.add(map);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;letters&quot;</span>, letters);</span><br><span class="line">        <span class="comment">// 私信目标</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;target&quot;</span>, getLetterTarget(conversationId));</span><br><span class="line">        <span class="comment">// 设置已读</span></span><br><span class="line">        List&lt;Integer&gt; ids = getLetterIds(letterList);</span><br><span class="line">        <span class="keyword">if</span> (!ids.isEmpty()) &#123;</span><br><span class="line">            messageService.readMessage(ids);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/letter-detail&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//找到私信的目标,也就是谁发来的私信</span></span><br><span class="line">    <span class="keyword">private</span> User <span class="title function_">getLetterTarget</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">        String[] ids = conversationId.split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">id0</span> <span class="operator">=</span> Integer.parseInt(ids[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">int</span> <span class="variable">id1</span> <span class="operator">=</span> Integer.parseInt(ids[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hostHolder.getUser().getId() == id0) &#123;</span><br><span class="line">            <span class="keyword">return</span> userService.findUserById(id1);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> userService.findUserById(id0);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; <span class="title function_">getLetterIds</span><span class="params">(List&lt;Message&gt; letterList)</span> &#123;</span><br><span class="line">        List&lt;Integer&gt; ids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (letterList != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Message message : letterList) &#123;</span><br><span class="line">                <span class="keyword">if</span> (hostHolder.getUser().getId() == message.getToId() &amp;&amp; message.getStatus() == <span class="number">0</span>) &#123;</span><br><span class="line">                    ids.add(message.getId());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ids;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送消息</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/letter/send&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sendLetter</span><span class="params">(String toName,String content)</span>&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">target</span> <span class="operator">=</span> messageService.finUserByName(toName);</span><br><span class="line">        <span class="keyword">if</span> (target == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> CommunityUtil.getJsonString(<span class="number">1</span>, <span class="string">&quot;目标用户不存在!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">        message.setFromId(hostHolder.getUser().getId());</span><br><span class="line">        message.setToId(target.getId());</span><br><span class="line">        <span class="keyword">if</span> (message.getFromId() &lt; message.getToId()) &#123;</span><br><span class="line">            message.setConversationId(message.getFromId() + <span class="string">&quot;_&quot;</span> + message.getToId());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            message.setConversationId(message.getToId() + <span class="string">&quot;_&quot;</span> + message.getFromId());</span><br><span class="line">        &#125;</span><br><span class="line">        message.setContent(content);</span><br><span class="line">        message.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        messageService.addMessage(message);</span><br><span class="line">        <span class="keyword">return</span> CommunityUtil.getJsonString(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="统一异常处理"><a href="#统一异常处理" class="headerlink" title="统一异常处理"></a>统一异常处理</h4><p>●@ControllerAdvice<br>    -用于修饰类，表示该类是Controller的全局配置类。<br>    -在此类中，可以对Controller进行如下三种全局配置:<br>    异常处理方案、绑定数据方案、绑定参数方案。<br>●@ExceptionHandler<br>    -用于修饰方法，该方法会在Controller出现异常后被调用，用于处理捕获到的异常。<br>@ ModelAttribute<br>    -用于修饰方法，该方法会在Controller方法执行前被调用， 用于为Model对象绑定参数。<br>●@DataBinder<br>    -用于修饰方法，该方法会在Controller方法执行前被调用，用于绑定参数的转换器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice(annotations = Controller.class)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExceptionAdvice</span> &#123;</span><br><span class="line">    <span class="meta">@ExceptionHandler(&#123;Exception.class&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleException</span><span class="params">(Exception e, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        log.error(<span class="string">&quot;服务器发生异常: &quot;</span> + e.getMessage());</span><br><span class="line">        <span class="keyword">for</span> (StackTraceElement element : e.getStackTrace()) &#123;</span><br><span class="line">            log.error(element.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">xRequestedWith</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;x-requested-with&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;XMLHttpRequest&quot;</span>.equals(xRequestedWith)) &#123;</span><br><span class="line">            response.setContentType(<span class="string">&quot;application/plain;charset=utf-8&quot;</span>);</span><br><span class="line">            <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">            writer.write(CommunityUtil.getJsonString(<span class="number">1</span>, <span class="string">&quot;服务器异常!&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            response.sendRedirect(request.getContextPath() + <span class="string">&quot;/error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="统一日志处理"><a href="#统一日志处理" class="headerlink" title="统一日志处理"></a>统一日志处理</h4><p>利用面向切面的思想,对整个业务层进行统一的日志记录</p>
<blockquote>
<p>AOP面向切面的知识在前面有记录</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceLogAspect</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(ServiceLogAspect.class);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(* com.nowcoder.community.service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pointcut</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;pointcut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">(JoinPoint joinPoint)</span> &#123;</span><br><span class="line">        <span class="comment">// 用户[1.2.3.4],在[xxx],访问了[com.nowcoder.community.service.xxx()].</span></span><br><span class="line">        <span class="type">ServletRequestAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> attributes.getRequest();</span><br><span class="line">        <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> request.getRemoteHost();</span><br><span class="line">        <span class="type">String</span> <span class="variable">now</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>).format(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="type">String</span> <span class="variable">target</span> <span class="operator">=</span> joinPoint.getSignature().getDeclaringTypeName() + <span class="string">&quot;.&quot;</span> + joinPoint.getSignature().getName();</span><br><span class="line">        logger.info(String.format(<span class="string">&quot;用户[%s],在[%s],访问了[%s].&quot;</span>, ip, now, target));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-Redis提高项目性能"><a href="#4-Redis提高项目性能" class="headerlink" title="4.Redis提高项目性能"></a>4.Redis提高项目性能</h3><h4 id="点赞"><a href="#点赞" class="headerlink" title="点赞"></a>点赞</h4><blockquote>
<p>点赞:支持对帖子,评论点赞;第一次点击是点赞,第二次点击取消点赞</p>
<p>首页点赞数量:统计帖子的点赞数量</p>
<p>详情页点赞数了:统计点赞数量,显示点赞状态</p>
</blockquote>
<p>业务层:实现点赞相关的业务,存放在redis中,使用set类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * redis实现点赞的业务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId    点赞人的id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> entityType    点赞的实体类型,是帖子?还是评论?</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> entityId  实体的id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">like</span><span class="params">(Integer userId,Integer entityType,Integer entityId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询某个实体的点赞数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> entityType    实体类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> entityId      实体ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  点赞数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Long <span class="title function_">findEntityLikeCount</span><span class="params">(Integer entityType,Integer entityId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询某人对某实体的点赞状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId    用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> entityType   实体类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> entityId  实体id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  1表示已点赞,0表示未点赞</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Integer <span class="title function_">findEntityLikeStatus</span><span class="params">(Integer userId,Integer entityType,Integer entityId)</span>;</span><br></pre></td></tr></table></figure>

<p>接口的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//点赞</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">like</span><span class="params">(Integer userId, Integer entityType, Integer entityId)</span> &#123;</span><br><span class="line">        String entityLikeKey= RedisKeyUtil.getEntityLikeKey(entityType, entityId);</span><br><span class="line">        <span class="comment">//判断这个key是否在redis中已经存在</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> redisTemplate.opsForSet().isMember(entityLikeKey, userId);</span><br><span class="line">        <span class="keyword">if</span> (isMember)&#123;  <span class="comment">//已经存在,取消点赞,从redis中移除</span></span><br><span class="line">            redisTemplate.opsForSet().remove(entityLikeKey, userId);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;     <span class="comment">//不存在,点赞,添加到redis中</span></span><br><span class="line">            redisTemplate.opsForSet().add(entityLikeKey, userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//查询某个实体的点赞数量</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">findEntityLikeCount</span><span class="params">(Integer entityType, Integer entityId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">entityLikeKey</span> <span class="operator">=</span> RedisKeyUtil.getEntityLikeKey(entityType, entityId);</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForSet().size(entityLikeKey);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//查询点赞状态</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">findEntityLikeStatus</span><span class="params">(Integer userId, Integer entityType, Integer entityId)</span> &#123;</span><br><span class="line">        String entityLikeKey= RedisKeyUtil.getEntityLikeKey(entityType, entityId);</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForSet().isMember(entityLikeKey, userId) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>表现层,调用业务层的方法,传递给前端页面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/like&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">like</span><span class="params">(Integer entityType,Integer entityId)</span>&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> hostHolder.getUser();   <span class="comment">//得到当前用户</span></span><br><span class="line">        likeService.like(user.getId(), entityType, entityId);<span class="comment">//实现点赞</span></span><br><span class="line">        <span class="type">long</span> likeCount=likeService.findEntityLikeCount(entityType, entityType); <span class="comment">//点赞数量</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">likeStatus</span> <span class="operator">=</span> likeService.findEntityLikeStatus(user.getId(), entityType, entityId);<span class="comment">//点赞状态</span></span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;likeCount&quot;</span>, likeCount);</span><br><span class="line">        map.put(<span class="string">&quot;likeStatus&quot;</span>, likeCount);</span><br><span class="line">        <span class="keyword">return</span> CommunityUtil.getJsonString(<span class="number">0</span>,<span class="literal">null</span>,map);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="我收到的赞"><a href="#我收到的赞" class="headerlink" title="我收到的赞"></a>我收到的赞</h4><blockquote>
<p>重构点赞功能:以用户为key,记录点赞的数量,increment(key),decrement(key)</p>
<p>开发个人主页:以用户为key,查询点赞数量</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//某个用户的赞 like:user:userId -&gt;int</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getLikeKey</span><span class="params">(Integer userId)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> PREFIX_USER_LIKE + SPLIT +userId;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>业务层,从redis中得到用户获得的赞的数量,对之前的点赞增加一个参数,也就是帖子的用户id,因为涉及到两次向redis中增加数量,所以使用了redis中的事务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">like</span><span class="params">(Integer userId, Integer entityType, Integer entityId, Integer entityUserId)</span> &#123;</span><br><span class="line">        redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">SessionCallback</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">execute</span><span class="params">(RedisOperations operations)</span> <span class="keyword">throws</span> DataAccessException&#123;</span><br><span class="line">                String entityLikeKey= RedisKeyUtil.getEntityLikeKey(entityType,entityId);</span><br><span class="line">                <span class="type">String</span> <span class="variable">userLikeKey</span> <span class="operator">=</span> RedisKeyUtil.getLikeKey(entityUserId);</span><br><span class="line">               Boolean isMember=redisTemplate.opsForSet().isMember(entityLikeKey,userId);</span><br><span class="line">                operations.multi();</span><br><span class="line">                <span class="keyword">if</span> (isMember)&#123;  <span class="comment">//已经存在,取消点赞,从redis中移除,点赞-1</span></span><br><span class="line">                    redisTemplate.opsForSet().remove(entityLikeKey, userId);</span><br><span class="line">                    operations.opsForValue().decrement(userLikeKey);</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;         <span class="comment">//不存在,点赞,添加到redis中</span></span><br><span class="line">                    redisTemplate.opsForSet().add(entityLikeKey, userId);</span><br><span class="line">                    operations.opsForValue().increment(userLikeKey);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> operations.exec();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询某个用户获得的赞</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">findUserLikeCount</span><span class="params">(Integer usrId)</span> &#123;</span><br><span class="line">        String userLikeKey=RedisKeyUtil.getLikeKey(usrId);</span><br><span class="line">        Integer count=(Integer) redisTemplate.opsForValue().get(userLikeKey);</span><br><span class="line">        <span class="keyword">return</span> count==<span class="literal">null</span> ? <span class="number">0</span> : count.intValue();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>表现层在用户个人主页通过调用业务层的方法实现对点赞数量的显示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//个人主页</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/profile/&#123;userId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getProfilePage</span><span class="params">(<span class="meta">@PathVariable</span> Integer userId,Model model)</span>&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(userId);</span><br><span class="line">        <span class="keyword">if</span> (user==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;该用户不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//用户的基本信息</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">        <span class="comment">//点赞的数量</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">likeCount</span> <span class="operator">=</span> likeService.findUserLikeCount(userId);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;likeCount&quot;</span>,likeCount);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/profile&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="关注-取消关注"><a href="#关注-取消关注" class="headerlink" title="关注,取消关注"></a>关注,取消关注</h4><blockquote>
<p>需求:<br>    开发关注,取消关注功能<br>    统计用户的关注数,粉丝数</p>
<p>关键:<br>    若a关注了b,那么a是b的粉丝(Follower),b是a的目标(Followee)<br>    关注的目标可以是用户,帖子,标题等,实现的时候将这些目标抽象为实体</p>
</blockquote>
<p>首先声明存放在redis的键值对,采用zset类型,方便以后灵活处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX_FOLLOWEE</span> <span class="operator">=</span> <span class="string">&quot;followee&quot;</span>;    <span class="comment">//关注的目标人</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX_FOLLOWER</span> <span class="operator">=</span> <span class="string">&quot;follower&quot;</span>;    <span class="comment">//粉丝</span></span><br><span class="line"><span class="comment">//某个用户关注的某个实体 followee:userId:entityType -&gt; zset(entityId) 进行排序</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getFolloweeKey</span><span class="params">(Integer userId,Integer entityType)</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> PREFIX_FOLLOWEE + SPLIT + userId + SPLIT + entityType;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//某个实体拥有的粉丝 follower:entityType:entityId -&gt; zset(userId) 进行排序</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getFollowerKey</span><span class="params">(Integer entityType,Integer entityId)</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> PREFIX_FOLLOWER + SPLIT + entityType + SPLIT + entityId;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>然后在业务层调用RedisTemplate实现查询某个实体关注的数量,粉丝的数量,以及是否已关注,然后在表现层中将这些数据传送给前端页面即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询关注的实体数量</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Long <span class="title function_">findFolloweeCount</span><span class="params">(Integer userId, Integer entityType)</span> &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">followeeKey</span> <span class="operator">=</span> RedisKeyUtil.getFolloweeKey(userId, entityType);</span><br><span class="line">      <span class="keyword">return</span> redisTemplate.opsForZSet().zCard(followeeKey);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//查询实体的粉丝数量</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Long <span class="title function_">findFollowerCount</span><span class="params">(Integer entityType, Integer entityId)</span> &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">followerKey</span> <span class="operator">=</span> RedisKeyUtil.getFollowerKey(entityType, entityId);</span><br><span class="line">      <span class="keyword">return</span> redisTemplate.opsForZSet().zCard(followerKey);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Boolean <span class="title function_">hasFollowed</span><span class="params">(Integer userId, Integer entityType, Integer entityId)</span> &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">followeeKey</span> <span class="operator">=</span> RedisKeyUtil.getFolloweeKey(userId, entityType);</span><br><span class="line">      <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> redisTemplate.opsForZSet().score(followeeKey, entityId);</span><br><span class="line">      <span class="keyword">return</span> score != <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>FollowController中实现关注和取消关注的逻辑,其实就是将数据保存在redis当中,通过异步调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//关注</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/follow&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">follow</span><span class="params">(Integer entityType,Integer entityId)</span>&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> hostHolder.getUser();</span><br><span class="line">        followService.follow(user.getId(), entityType, entityId);</span><br><span class="line">        <span class="keyword">return</span> CommunityUtil.getJsonString(<span class="number">0</span>, <span class="string">&quot;已关注&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//取消关注</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/unfollow&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">unfollow</span><span class="params">(Integer entityType,Integer entityId)</span>&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> hostHolder.getUser();</span><br><span class="line">        followService.unFollow(user.getId(), entityType, entityId);</span><br><span class="line">        <span class="keyword">return</span> CommunityUtil.getJsonString(<span class="number">0</span>, <span class="string">&quot;已取消关注&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>UerController中添加查询当前用户关注人的数量,粉丝数量以及是否已关注,将数据发送给前端页面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//当前用户关注人的数量</span></span><br><span class="line">      <span class="type">Long</span> <span class="variable">followeeCount</span> <span class="operator">=</span> followService.findFolloweeCount(userId, <span class="number">3</span>);</span><br><span class="line">      model.addAttribute(<span class="string">&quot;followeeCount&quot;</span>,followeeCount);</span><br><span class="line">      <span class="comment">//粉丝数量</span></span><br><span class="line">      <span class="type">Long</span> <span class="variable">followerCount</span> <span class="operator">=</span> followService.findFollowerCount(<span class="number">3</span>, userId);</span><br><span class="line">      model.addAttribute(<span class="string">&quot;followerCount&quot;</span>,followerCount);</span><br><span class="line">      <span class="comment">//是否已关注</span></span><br><span class="line">      <span class="type">boolean</span> hasFollowed=<span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (hostHolder.getUser()!=<span class="literal">null</span>)&#123;</span><br><span class="line">          hasFollowed=followService.hasFollowed(hostHolder.getUser().getId(), <span class="number">3</span>, userId);</span><br><span class="line">      &#125;</span><br><span class="line">      model.addAttribute(<span class="string">&quot;hasFollowed&quot;</span>,hasFollowed);</span><br></pre></td></tr></table></figure>

<h4 id="关注的列表-粉丝的列表"><a href="#关注的列表-粉丝的列表" class="headerlink" title="关注的列表,粉丝的列表"></a>关注的列表,粉丝的列表</h4><blockquote>
<p>业务层:查询某个用户关注的人,支持分页;查询某个用户的粉丝,支持分页</p>
<p>表现层:处理”查询关注的人”,”查询粉丝”的请求;辨析”查询关注的人”,”查询粉丝”模板</p>
</blockquote>
<p>在业务层实现两个方法,一个是查询当前用户关注的人,一个是查询当前用户的粉丝,均可实现分页查询,两个方法非常相似</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询当前用户关注的人</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">findFollowee</span><span class="params">(Integer userId, Integer offset, Integer limit)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">followeeKey</span> <span class="operator">=</span> RedisKeyUtil.getFolloweeKey(userId, <span class="number">3</span>);</span><br><span class="line">        Set&lt;Integer&gt; targetIds = redisTemplate.opsForZSet().reverseRange(followeeKey, offset, offset + limit - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (targetIds==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ArrayList&lt;Map&lt;String, Object&gt;&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Integer targetId : targetIds)&#123;</span><br><span class="line">            HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(targetId);</span><br><span class="line">            map.put(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">            <span class="comment">//获得用户的关注的时间</span></span><br><span class="line">            <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> redisTemplate.opsForZSet().score(followeeKey, targetId);</span><br><span class="line">            map.put(<span class="string">&quot;followTime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(score.longValue()));</span><br><span class="line">            list.add(map);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">findFollower</span><span class="params">(Integer userId, Integer offset, Integer limit)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">followerKey</span> <span class="operator">=</span> RedisKeyUtil.getFollowerKey(<span class="number">3</span>, userId);</span><br><span class="line">        Set&lt;Integer&gt; targetIds = redisTemplate.opsForZSet().reverseRange(followerKey, offset, offset + limit - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (targetIds==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ArrayList&lt;Map&lt;String, Object&gt;&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Integer targetId : targetIds)&#123;</span><br><span class="line">            HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(targetId);</span><br><span class="line">            map.put(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">            <span class="comment">//获得用户的关注的时间</span></span><br><span class="line">            <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> redisTemplate.opsForZSet().score(followerKey, targetId);</span><br><span class="line">            map.put(<span class="string">&quot;followTime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(score.longValue()));</span><br><span class="line">            list.add(map);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>业务层,通过调用service层中的方法,通过异步请求,将当前用户关注的人,以及当前用户的粉丝,发送给前端界面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询某用户关注的人,分页显示</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/followees/&#123;userId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getFollowees</span><span class="params">(<span class="meta">@PathVariable</span> Integer userId, Page page, Model model)</span>&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(userId);</span><br><span class="line">        <span class="keyword">if</span> (user==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;该用户不存在!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">        page.setLimit(<span class="number">5</span>);</span><br><span class="line">        page.setPath(<span class="string">&quot;/followees/&quot;</span>+userId);</span><br><span class="line">        page.setRows(Math.toIntExact(followService.findFolloweeCount(userId, <span class="number">3</span>)));</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; userList = followService.findFollowee(userId, page.getOffset(), page.getLimit());</span><br><span class="line">        <span class="keyword">if</span> (userList!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (Map&lt;String,Object&gt; map : userList)&#123;</span><br><span class="line">                <span class="type">User</span> <span class="variable">u</span> <span class="operator">=</span>(User) map.get(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">                <span class="comment">//当前用户是否与粉丝互关</span></span><br><span class="line">                map.put(<span class="string">&quot;hasFollowed&quot;</span>, hasFollowed(u.getId()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;users&quot;</span>,userList);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/followee&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//查询某用户的粉丝,分页显示</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/followers/&#123;userId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getFollowers</span><span class="params">(<span class="meta">@PathVariable</span> Integer userId, Page page, Model model)</span>&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(userId);</span><br><span class="line">        <span class="keyword">if</span> (user==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;该用户不存在!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">        page.setLimit(<span class="number">5</span>);</span><br><span class="line">        page.setPath(<span class="string">&quot;/followers/&quot;</span>+userId);</span><br><span class="line">        page.setRows(Math.toIntExact(followService.findFollowerCount(<span class="number">3</span>, userId)));</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; userList = followService.findFollower(userId, page.getOffset(), page.getLimit());</span><br><span class="line">        <span class="keyword">if</span> (userList!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (Map&lt;String,Object&gt; map : userList)&#123;</span><br><span class="line">                <span class="type">User</span> <span class="variable">u</span> <span class="operator">=</span>(User) map.get(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">                <span class="comment">//当前用户是否与粉丝互关</span></span><br><span class="line">                map.put(<span class="string">&quot;hasFollowed&quot;</span>, hasFollowed(u.getId()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;users&quot;</span>,userList);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/follower&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断该用户是否互相关注</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">hasFollowed</span><span class="params">(Integer userId)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (hostHolder.getUser()==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> followService.hasFollowed(hostHolder.getUser().getId(), <span class="number">3</span>, userId);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="优化登录模块"><a href="#优化登录模块" class="headerlink" title="优化登录模块"></a>优化登录模块</h4><blockquote>
<p>使用redis存储验证码<br>    验证码需要频繁的访问与刷新，对性能要求较高。<br>    验证码不需永久保存，通常在很短的时间后就会失效。<br>    分布式部署时，存在Session共享的问题。</p>
<p>使用Redis存储登录凭证<br>    处理每次请求时，都要查询用户的登录凭证，访问的频率非常高。</p>
<p>使用Redis缓存用户信息<br>    处理每次请求时，都要根据凭证查询用户信息，访问的频率非常高。</p>
</blockquote>
<p><strong>1.使用redis存储验证码</strong></p>
<p>首先设置redis中的key,这里的key是给访问登录界面的用户一个临时的随机字符串,保存在cookie中,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX_KAPTCHA</span> <span class="operator">=</span> <span class="string">&quot;kaptcha&quot;</span>;    <span class="comment">//验证码</span></span><br><span class="line"><span class="comment">//登录验证码 owner作为一个访问登录界面的凭证</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getKaptchaKey</span><span class="params">(String owner)</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> PREFIX_KAPTCHA + SPLIT + owner;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在业务层中的得到验证码中,这里验证码不再存放在session中,而是存放在cookie中,设置有限期60s</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*得到验证码增加的逻辑*/</span></span><br><span class="line"><span class="comment">//验证码的归属</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">kaptchaOwner</span> <span class="operator">=</span> CommunityUtil.getUUID();</span><br><span class="line">      <span class="type">Cookie</span> <span class="variable">cookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cookie</span>(<span class="string">&quot;kaptchaOwner&quot;</span>, kaptchaOwner);</span><br><span class="line">      cookie.setMaxAge(<span class="number">60</span>);</span><br><span class="line">      response.addCookie(cookie);</span><br><span class="line">      <span class="comment">//将验证码存入redis</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisKeyUtil.getKaptchaKey(kaptchaOwner);</span><br><span class="line">      redisTemplate.opsForValue().set(key, text,<span class="number">60</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*登录模块增加的逻辑</span></span><br><span class="line"><span class="comment">注意: 这里在方法参数中使用@CookieValue注解,得到上一步COOkie中的存放的验证码的key</span></span><br><span class="line"><span class="comment"> @CookieValue(&quot;kaptchaOwner&quot;) String kaptchaOwner</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">String</span> <span class="variable">kapthcha</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">if</span> (StringUtils.isNotBlank(kaptchaOwner))&#123;</span><br><span class="line">          String redisKey=RedisKeyUtil.getKaptchaKey(kaptchaOwner);</span><br><span class="line">          kapthcha =(String) redisTemplate.opsForValue().get(redisKey);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p><strong>2.使用Redis存储登录凭证</strong></p>
<p>声明存放在redis中的登录凭证的key,以及取到登录凭证的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX_TICKET</span> <span class="operator">=</span> <span class="string">&quot;ticket&quot;</span>;        <span class="comment">//登录凭证</span></span><br><span class="line"><span class="comment">//登录的凭证</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getTicketKey</span><span class="params">(String ticket)</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> PREFIX_TICKET + SPLIT + ticket;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在业务层中需要改善一下代码,凭证本来存放在数据库中,现在存放在redis中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//改善使用redis</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logout</span><span class="params">(String ticket)</span> &#123;</span><br><span class="line">       <span class="comment">//loginTicketMapper.updateStatus(ticket, 1);  //状态为1表示退出</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">ticketKey</span> <span class="operator">=</span> RedisKeyUtil.getTicketKey(ticket);</span><br><span class="line">       <span class="type">LoginTicket</span> <span class="variable">loginTicket</span> <span class="operator">=</span> (LoginTicket)redisTemplate.opsForValue().get(ticketKey);</span><br><span class="line">       loginTicket.setStatus(<span class="number">1</span>);</span><br><span class="line">       redisTemplate.opsForValue().set(ticketKey, loginTicket);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 搜索凭证是否存在</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ticket    用户凭证</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span>      存在的对象</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="comment">//改善使用redis</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> LoginTicket <span class="title function_">findLoginTicket</span><span class="params">(String ticket)</span> &#123;</span><br><span class="line">       <span class="comment">//return loginTicketMapper.selectByTicket(ticket);  从redis中查</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">ticketKey</span> <span class="operator">=</span> RedisKeyUtil.getTicketKey(ticket);</span><br><span class="line">       <span class="keyword">return</span> (LoginTicket) redisTemplate.opsForValue().get(ticketKey);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//登录时存入到redis中</span></span><br><span class="line"> <span class="type">String</span> <span class="variable">ticketKey</span> <span class="operator">=</span> RedisKeyUtil.getTicketKey(loginTicket.getTicket());</span><br><span class="line"> redisTemplate.opsForValue().set(ticketKey, loginTicket);</span><br></pre></td></tr></table></figure>

<p><strong>3.使用Redis缓存用户信息</strong></p>
<p>声明用户信息存放在redis中的key</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX_USER</span> <span class="operator">=</span> <span class="string">&quot;user&quot;</span>;        <span class="comment">//用户信息</span></span><br><span class="line"><span class="comment">//用户信息</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getUserKey</span><span class="params">(Integer userId)</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> PREFIX_TICKET + SPLIT + userId;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在UserService业务层中声明三个方法一个优先从缓存中取值,一个是如果取不到值时初始化缓存,一个是数据变更时清除缓存</p>
<p>同时根据id查询缓存的方法不再到数据库中查询,直接到redis中查询,如果没有那么初始化缓存,如果用户的信息变更了,就是使用了update方法,比如更新头像,修改密码之类的,就需要删除缓存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.优先从缓存中取值</span></span><br><span class="line">    <span class="keyword">private</span> User <span class="title function_">getCache</span><span class="params">(Integer userId)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> RedisKeyUtil.getUserKey(userId);</span><br><span class="line">        <span class="keyword">return</span> (User) redisTemplate.opsForValue().get(redisKey);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.取不到时初始化缓存数据</span></span><br><span class="line">    <span class="keyword">private</span> User <span class="title function_">initCache</span><span class="params">(Integer userId)</span>&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectById(userId);</span><br><span class="line">        <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> RedisKeyUtil.getUserKey(userId);</span><br><span class="line">        redisTemplate.opsForValue().set(redisKey, user);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.数据变更时清除缓存</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">clearCache</span><span class="params">(Integer userId)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userKey</span> <span class="operator">=</span> RedisKeyUtil.getUserKey(userId);</span><br><span class="line">        redisTemplate.delete(userKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//根据id查找用户</span></span><br><span class="line">    <span class="comment">//redis改善</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findUserById</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="comment">//User user = userMapper.selectById(id);</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> getCache(id);</span><br><span class="line">        <span class="keyword">if</span> (user==<span class="literal">null</span>)&#123;</span><br><span class="line">            user=initCache(id);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-kafka实现异步消息系统"><a href="#5-kafka实现异步消息系统" class="headerlink" title="5.kafka实现异步消息系统"></a>5.kafka实现异步消息系统</h3><blockquote>
<p>kafka没有系统学习过,并且kafka更倾向于大数据领域,这里只是简单使用一下,看后期能不能用rabbitmq进行重构</p>
</blockquote>
<h4 id="1-发送系统通知"><a href="#1-发送系统通知" class="headerlink" title="1.发送系统通知"></a>1.发送系统通知</h4><blockquote>
<p>触发事件<br>   评论后，发布通知<br>   点赞后，发布通知<br>   关注后，发布通知</p>
<p>处理事件<br>   封装事件对象<br>   开发事件的生产者<br>   开发事件的消费者</p>
</blockquote>
<p>封装事件对象</p>
<h4 id="2-显示系统通知"><a href="#2-显示系统通知" class="headerlink" title="2.显示系统通知"></a>2.显示系统通知</h4><h2 id="3-基于Netty聊天室-RPC"><a href="#3-基于Netty聊天室-RPC" class="headerlink" title="3.基于Netty聊天室,RPC"></a>3.基于Netty聊天室,RPC</h2><h2 id="4-在线教育项目"><a href="#4-在线教育项目" class="headerlink" title="4.在线教育项目"></a>4.在线教育项目</h2><h3 id="1-介绍一下项目"><a href="#1-介绍一下项目" class="headerlink" title="1.介绍一下项目"></a>1.介绍一下项目</h3><p>我们的项目是一项面向青少年的在线教育服务,分为前台用户系统和后台运营平台,前台用户系统包括了课程视频,课程讲师,论坛问答,文章阅读,趣味游戏几个部分,项目使用微服务架构进行前后端分立开发</p>
<p>后端的主要技术架构是：SpringBoot,SpringCloud,MyBatis-Plus,MySQL,nginx</p>
<p>前端的架构是：Node.js,Vue.js,element-ui</p>
<p>由于我微服务知识掌握的比较少,所以我在项目中主要负责开发后端的登录功能,同时使用redis进行项目中的缓存处理,还有负责日常的MySQL语句的编写优化.</p>
<h3 id="2-登录功能是如何实现的"><a href="#2-登录功能是如何实现的" class="headerlink" title="2.登录功能是如何实现的?"></a>2.登录功能是如何实现的?</h3><p><strong>登录功能是通过token+redis进行实现,然后结合threadlocal和拦截器实现了全局token验证</strong></p>
<p>目前常见的登录方式有两种,也就是有状态登录和无状态登录</p>
<p>其中有状态登录比较典型的是基于session实现的登录,登录成功之后把数据放到session中,在判断是否登录时从session中获取数据,可以得到登录的信息</p>
<p>但是会出现集群的<strong>session共享</strong>的问题,也就是多台Tomcat不能共享到session,切换服务就会导致数据丢失,虽然有seesion复制可以解决这一问题,但是这对性能的消耗是很大的</p>
<p>无状态登录服务端是不保存任何客户端信息的,客户端每次请求必须具备描述信息,通过这些信息识别客户端身份.</p>
<p>以短信验证码登录为例</p>
<ol>
<li><p>首先用户提交手机号,检查手机号是否合法,合法之后生成验证码,保存验证码到redis中</p>
<p>使用手机号作为key.验证码信息作为值,同时为它设置有效期一分钟</p>
</li>
<li><p>用户输入验证码之后,检验用户输入的验证码是否和从redis中查询的一致,不一致返回错误</p>
</li>
<li><p>一致后根据手机号到数据库中查询用户,用户如果存在,将用户信息存到redis中,同时将token作为凭证返回给客户端</p>
<p>我们使用了hash结构进行存储,使用jwt生成的token为字符串,值为用户的信息</p>
</li>
<li><p>用户不存在,创建新的用户,保存到redis数据库中,token作为凭证返回给客户端</p>
</li>
<li><p>以后每次请求,客户端都携带token访问</p>
</li>
</ol>
<p><strong>鉴权业务的思路(实现单点登录)</strong></p>
<p>我们使用了threadlocal+拦截器实现登录校验的工作</p>
<ol>
<li>当用户发出请求访问其他模块之后,我们首先看用户是否携带了token如果请求头没有token那么直接放行</li>
<li>如果存在,通过token从redis中查询用户信息,如果redis中没有该用户信息,那么同样放行</li>
<li>如果存在的话将redis中的信息存放到ThreadLocal中,并设置token的刷新时间,然后放行进入第二个拦截器中</li>
<li>在第二个拦截器中我们如果能从Threadlocal中得到用户的信息,那么就可以正常访问其他页面</li>
</ol>
<p><strong>整个登录过程最关键的点是什么?</strong></p>
<p>因为以后的每次请求中,token是识别用户身份的唯一凭证,如果加密不够严密,那么就会造成一定的安全问题</p>
<p><strong>遇到了什么问题?</strong></p>
<p>在关于token刷新有效期的时候遇到了问题,因为一开始只使用了一个拦截器,也就是只对需要登录的模块进行了拦截操作,才会刷新有效期,而对于访问其他模块则不能刷新有效期</p>
<p><strong>如何解决?</strong></p>
<p>我们在原有的拦截器前面有加了一个拦截器,在这一个拦截其中进行刷新token有效期的操作,在后面一个拦截器中只做登录判断的操作.确保一切请求都先通过第一个拦截器</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">宇汐</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/05/17/%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/%E9%A1%B9%E7%9B%AE/">http://example.com/2022/05/17/%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/%E9%A1%B9%E7%9B%AE/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">宇汐的时光录</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://siyu-1314.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2/background1.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/05/17/%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/%E7%AE%97%E6%B3%95%E6%B0%B8%E8%BF%9C%E7%9A%84%E7%97%9B/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/"><img class="prev-cover" src="https://siyu-1314.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2/background1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">排序算法</div></div></a></div><div class="next-post pull-right"><a href="/2022/05/17/%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/%E6%A1%86%E6%9E%B6/"><img class="next-cover" src="https://siyu-1314.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2/background1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">框架篇</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://siyu-1314.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2/header.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">宇汐</div><div class="author-info__description">梦很遥远,她很优秀</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/linxisiyu"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/linxisiyu" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1841661433@qq.com" target="_blank" title="给我发邮件"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/485044334?spm_id_from=333.1007.0.0" target="_blank" title="我的B站"><i class="fab fa-bilibili"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">细水长流,静水深流</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%BB%BFB%E7%AB%99%E8%A7%86%E9%A2%91%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.</span> <span class="toc-text">1.仿B站视频项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%BB%BF%E7%89%9B%E5%AE%A2%E8%AE%BA%E5%9D%9B%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.</span> <span class="toc-text">2.仿牛客论坛项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%A6%96%E9%A1%B5%E5%B8%96%E5%AD%90%E5%88%86%E9%A1%B5%E5%B1%95%E7%A4%BA"><span class="toc-number">2.1.</span> <span class="toc-text">1.首页帖子分页展示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E5%8A%9F%E8%83%BD"><span class="toc-number">2.2.</span> <span class="toc-text">2.登录注册功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6"><span class="toc-number">2.2.1.</span> <span class="toc-text">发送邮件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E5%8A%9F%E8%83%BD"><span class="toc-number">2.2.2.</span> <span class="toc-text">注册功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E9%80%80%E5%87%BA%E5%8A%9F%E8%83%BD"><span class="toc-number">2.2.3.</span> <span class="toc-text">登录退出功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-number">2.2.4.</span> <span class="toc-text">验证码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E7%99%BB%E5%BD%95%E4%BF%A1%E6%81%AF"><span class="toc-number">2.2.5.</span> <span class="toc-text">显示登录信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%A6%E5%8F%B7%E8%AE%BE%E7%BD%AE"><span class="toc-number">2.2.6.</span> <span class="toc-text">账号设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E7%99%BB%E5%BD%95%E7%8A%B6%E6%80%81"><span class="toc-number">2.2.7.</span> <span class="toc-text">检查登录状态</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%BC%80%E5%8F%91%E7%A4%BE%E5%8C%BA%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD"><span class="toc-number">2.3.</span> <span class="toc-text">3.开发社区核心功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E6%95%8F%E6%84%9F%E8%AF%8D"><span class="toc-number">2.3.1.</span> <span class="toc-text">过滤敏感词</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E5%B8%96%E5%AD%90"><span class="toc-number">2.3.2.</span> <span class="toc-text">发布帖子</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%96%E5%AD%90%E8%AF%A6%E6%83%85"><span class="toc-number">2.3.3.</span> <span class="toc-text">帖子详情</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E8%AF%84%E8%AE%BA"><span class="toc-number">2.3.4.</span> <span class="toc-text">显示评论</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E8%AF%84%E8%AE%BA"><span class="toc-number">2.3.5.</span> <span class="toc-text">添加评论</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A7%81%E4%BF%A1%E5%8A%9F%E8%83%BD"><span class="toc-number">2.3.6.</span> <span class="toc-text">私信功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">2.3.7.</span> <span class="toc-text">统一异常处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E6%97%A5%E5%BF%97%E5%A4%84%E7%90%86"><span class="toc-number">2.3.8.</span> <span class="toc-text">统一日志处理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Redis%E6%8F%90%E9%AB%98%E9%A1%B9%E7%9B%AE%E6%80%A7%E8%83%BD"><span class="toc-number">2.4.</span> <span class="toc-text">4.Redis提高项目性能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%82%B9%E8%B5%9E"><span class="toc-number">2.4.1.</span> <span class="toc-text">点赞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%91%E6%94%B6%E5%88%B0%E7%9A%84%E8%B5%9E"><span class="toc-number">2.4.2.</span> <span class="toc-text">我收到的赞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E6%B3%A8-%E5%8F%96%E6%B6%88%E5%85%B3%E6%B3%A8"><span class="toc-number">2.4.3.</span> <span class="toc-text">关注,取消关注</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E6%B3%A8%E7%9A%84%E5%88%97%E8%A1%A8-%E7%B2%89%E4%B8%9D%E7%9A%84%E5%88%97%E8%A1%A8"><span class="toc-number">2.4.4.</span> <span class="toc-text">关注的列表,粉丝的列表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97"><span class="toc-number">2.4.5.</span> <span class="toc-text">优化登录模块</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-kafka%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E6%B6%88%E6%81%AF%E7%B3%BB%E7%BB%9F"><span class="toc-number">2.5.</span> <span class="toc-text">5.kafka实现异步消息系统</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%8F%91%E9%80%81%E7%B3%BB%E7%BB%9F%E9%80%9A%E7%9F%A5"><span class="toc-number">2.5.1.</span> <span class="toc-text">1.发送系统通知</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%98%BE%E7%A4%BA%E7%B3%BB%E7%BB%9F%E9%80%9A%E7%9F%A5"><span class="toc-number">2.5.2.</span> <span class="toc-text">2.显示系统通知</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%9F%BA%E4%BA%8ENetty%E8%81%8A%E5%A4%A9%E5%AE%A4-RPC"><span class="toc-number">3.</span> <span class="toc-text">3.基于Netty聊天室,RPC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%9C%A8%E7%BA%BF%E6%95%99%E8%82%B2%E9%A1%B9%E7%9B%AE"><span class="toc-number">4.</span> <span class="toc-text">4.在线教育项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BB%8B%E7%BB%8D%E4%B8%80%E4%B8%8B%E9%A1%B9%E7%9B%AE"><span class="toc-number">4.1.</span> <span class="toc-text">1.介绍一下项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84"><span class="toc-number">4.2.</span> <span class="toc-text">2.登录功能是如何实现的?</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/05/21/jsp%E8%80%83%E8%AF%95%E8%8C%83%E5%9B%B4/" title="jsp复习"><img src="https://siyu-1314.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2/background1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="jsp复习"/></a><div class="content"><a class="title" href="/2022/05/21/jsp%E8%80%83%E8%AF%95%E8%8C%83%E5%9B%B4/" title="jsp复习">jsp复习</a><time datetime="2022-05-21T14:42:36.849Z" title="发表于 2022-05-21 22:42:36">2022-05-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/05/19/%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/%E7%AE%97%E6%B3%95%E6%B0%B8%E8%BF%9C%E7%9A%84%E7%97%9B/%E9%93%BE%E8%A1%A8,%E6%A0%91,%E5%9B%BE/" title="链表,二叉树和图"><img src="https://siyu-1314.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2/background1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="链表,二叉树和图"/></a><div class="content"><a class="title" href="/2022/05/19/%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/%E7%AE%97%E6%B3%95%E6%B0%B8%E8%BF%9C%E7%9A%84%E7%97%9B/%E9%93%BE%E8%A1%A8,%E6%A0%91,%E5%9B%BE/" title="链表,二叉树和图">链表,二叉树和图</a><time datetime="2022-05-19T00:55:55.200Z" title="发表于 2022-05-19 08:55:55">2022-05-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/05/17/%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/%E7%AE%97%E6%B3%95%E6%B0%B8%E8%BF%9C%E7%9A%84%E7%97%9B/%E9%9A%8F%E5%86%99%E8%AE%B0%E5%BD%95/" title="无题"><img src="https://siyu-1314.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2/background.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2022/05/17/%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/%E7%AE%97%E6%B3%95%E6%B0%B8%E8%BF%9C%E7%9A%84%E7%97%9B/%E9%9A%8F%E5%86%99%E8%AE%B0%E5%BD%95/" title="无题">无题</a><time datetime="2022-05-17T01:48:37.740Z" title="发表于 2022-05-17 09:48:37">2022-05-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/05/17/%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/%E7%AE%97%E6%B3%95%E6%B0%B8%E8%BF%9C%E7%9A%84%E7%97%9B/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/" title="排序算法"><img src="https://siyu-1314.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2/background1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="排序算法"/></a><div class="content"><a class="title" href="/2022/05/17/%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/%E7%AE%97%E6%B3%95%E6%B0%B8%E8%BF%9C%E7%9A%84%E7%97%9B/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/" title="排序算法">排序算法</a><time datetime="2022-05-17T01:48:37.737Z" title="发表于 2022-05-17 09:48:37">2022-05-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/05/17/%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/%E9%A1%B9%E7%9B%AE/" title="项目篇"><img src="https://siyu-1314.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2/background1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="项目篇"/></a><div class="content"><a class="title" href="/2022/05/17/%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AE%B0%E6%95%B4%E7%90%86/%E9%A1%B9%E7%9B%AE/" title="项目篇">项目篇</a><time datetime="2022-05-17T01:48:37.731Z" title="发表于 2022-05-17 09:48:37">2022-05-17</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://siyu-1314.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2/background1.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By 宇汐</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">嘿嘿,欢迎你来到这里,我们做朋友吧━(*｀∀´*)ノ亻!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="/music/"]):not([href="/no-pjax/"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>